<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pisa.core.param &mdash; PISA 4.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=9f5556dd"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PISA
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PISA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pisa.core.param</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pisa.core.param</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Define Param, ParamSet, and ParamSelector classes for handling parameters, sets</span>
<span class="sd">of parameters, and being able to discretely switch between sets of parameter</span>
<span class="sd">values.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">setitem</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pint</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>

<span class="kn">from</span> <span class="nn">pisa</span> <span class="kn">import</span> <span class="n">ureg</span>
<span class="kn">from</span> <span class="nn">pisa.core.prior</span> <span class="kn">import</span> <span class="n">Prior</span>
<span class="kn">from</span> <span class="nn">pisa.utils</span> <span class="kn">import</span> <span class="nb">callable</span>
<span class="kn">from</span> <span class="nn">pisa.utils</span> <span class="kn">import</span> <span class="n">jsons</span>
<span class="kn">from</span> <span class="nn">pisa.utils.comparisons</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">interpret_quantity</span><span class="p">,</span> <span class="n">isbarenumeric</span><span class="p">,</span> <span class="n">normQuant</span><span class="p">,</span> <span class="n">recursiveEquality</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pisa.utils.hash</span> <span class="kn">import</span> <span class="n">hash_obj</span>
<span class="kn">from</span> <span class="nn">pisa.utils.log</span> <span class="kn">import</span> <span class="n">logging</span><span class="p">,</span> <span class="n">set_verbosity</span>
<span class="kn">from</span> <span class="nn">pisa.utils.random_numbers</span> <span class="kn">import</span> <span class="n">get_random_state</span>
<span class="kn">from</span> <span class="nn">pisa.utils.stats</span> <span class="kn">import</span> <span class="n">ALL_METRICS</span><span class="p">,</span> <span class="n">CHI2_METRICS</span><span class="p">,</span> <span class="n">LLH_METRICS</span>
<span class="kn">from</span> <span class="nn">pisa.utils.comparisons</span> <span class="kn">import</span> <span class="n">FTYPE_PREC</span>
<span class="kn">from</span> <span class="nn">pisa.utils.callable</span> <span class="kn">import</span> <span class="n">Funct</span>
<span class="kn">from</span> <span class="nn">pisa.utils.resources</span> <span class="kn">import</span> <span class="n">find_resource</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Param&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DerivedParam&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ParamSet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ParamSelector&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_Param&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_ParamSet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_ParamSelector&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;J.L. Lanfranchi&#39;</span>

<span class="n">__license__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;Copyright (c) 2014-2019, The IceCube Collaboration</span>

<span class="s1"> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s1"> you may not use this file except in compliance with the License.</span>
<span class="s1"> You may obtain a copy of the License at</span>

<span class="s1">   http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s1"> Unless required by applicable law or agreed to in writing, software</span>
<span class="s1"> distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s1"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s1"> See the License for the specific language governing permissions and</span>
<span class="s1"> limitations under the License.&#39;&#39;&#39;</span>


<span class="c1"># TODO: Make property &quot;frozen&quot; or &quot;read_only&quot; so params in param set e.g.</span>
<span class="c1"># returned by a template maker -- which updating the values of will NOT have</span>
<span class="c1"># the effect the user might expect -- will be explicitly forbidden?</span>

<span class="c1"># TODO: units: pass in attached to values, or as separate kwarg? If e.g.</span>
<span class="c1"># value hasn&#39;t been set yet, then there&#39;s no implicit units to reference</span>
<span class="c1"># when setting the prior, range, and possibly other things (which all need to</span>
<span class="c1"># at least have compatible units)</span>
<div class="viewcode-block" id="Param">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param">[docs]</a>
<span class="nd">@total_ordering</span>
<span class="k">class</span> <span class="nc">Param</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameter class to store any kind of parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>

<span class="sd">    value : scalar, bool, pint Quantity (value with units), string, or None</span>

<span class="sd">    prior : pisa.prior.Prior or instantiable thereto</span>

<span class="sd">    range : sequence of two scalars or Pint quantities, or None</span>

<span class="sd">    is_fixed : bool</span>

<span class="sd">    unique_id : string, optional</span>
<span class="sd">        If None is provided (default), `unique_id` is set to `name`</span>

<span class="sd">    is_discrete : bool, optional</span>
<span class="sd">        Default is False</span>

<span class="sd">    scales_as_log : bool, optional</span>
<span class="sd">        Rescale the log of the parameter&#39;s value between 0 and 1 for minimization,</span>
<span class="sd">        rather than the value itself. This can help optimizing parameters spanning</span>
<span class="sd">        several orders of magnitude.</span>

<span class="sd">    nominal_value : same type as `value`, optional</span>
<span class="sd">        If None (default), set to same as `value`</span>

<span class="sd">    tex : None or string</span>

<span class="sd">    help : string</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    In the case of a free (`is_fixed`=False) parameter, a valid range for the</span>
<span class="sd">    parameter should be spicfied and a prior must be assigned to compute llh</span>
<span class="sd">    and chi2 values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pisa import ureg</span>
<span class="sd">    &gt;&gt;&gt; from pisa.core.prior import Prior</span>
<span class="sd">    &gt;&gt;&gt; gaussian = Prior(kind=&#39;gaussian&#39;, mean=10*ureg.meter,</span>
<span class="sd">    ...                  stddev=1*ureg.meter)</span>
<span class="sd">    &gt;&gt;&gt; x = Param(name=&#39;x&#39;, value=1.5*ureg.foot, prior=gaussian,</span>
<span class="sd">    ...           range=[-10, 60]*ureg.foot, is_fixed=False, is_discrete=False)</span>
<span class="sd">    &gt;&gt;&gt; x.value</span>
<span class="sd">    &lt;Quantity(1.5, &#39;foot&#39;)&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(x.prior_penalty(metric=&#39;llh&#39;))</span>
<span class="sd">    -45.532515919999994</span>
<span class="sd">    &gt;&gt;&gt; print(x.to(&#39;m&#39;))</span>

<span class="sd">    &gt;&gt;&gt; x.value = 10*ureg.m</span>
<span class="sd">    &gt;&gt;&gt; print(x.value)</span>
<span class="sd">    &lt;Quantity(32.8083989501, &#39;foot&#39;)&gt;</span>
<span class="sd">    &gt;&gt;&gt; x.ito(&#39;m&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(x.value)</span>

<span class="sd">    &gt;&gt;&gt; x.prior_penalty(metric=&#39;llh&#39;)</span>
<span class="sd">    -1.5777218104420236e-30</span>
<span class="sd">    &gt;&gt;&gt; p.nominal_value</span>

<span class="sd">    &gt;&gt;&gt; x.reset()</span>
<span class="sd">    &gt;&gt;&gt; print(x.value)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=protected-access</span>
    <span class="n">_slots</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unique_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_fixed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_discrete&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scales_as_log&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_rescaled_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;help&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_units&#39;</span><span class="p">,</span>
        <span class="s1">&#39;normalize_values&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_state_attrs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unique_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_fixed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_discrete&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scales_as_log&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;help&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="n">prior</span><span class="p">,</span>
        <span class="nb">range</span><span class="p">,</span>
        <span class="n">is_fixed</span><span class="p">,</span>
        <span class="n">unique_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scales_as_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nominal_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nominal_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span> <span class="o">=</span> <span class="n">scales_as_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">unique_id</span> <span class="k">if</span> <span class="n">unique_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span> <span class="o">=</span> <span class="n">tex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="n">help</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="nb">range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fixed</span> <span class="o">=</span> <span class="n">is_fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_discrete</span> <span class="o">=</span> <span class="n">is_discrete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">nominal_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nominal_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span> <span class="ow">and</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="nb">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A parameter with log-scaling must have a range that is &quot;</span>
                <span class="s2">&quot;either entirely negative or entirely positive.&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, nominal_value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal_value</span><span class="si">}</span><span class="s2">, range: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="si">}</span><span class="s2">, prior: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="si">}</span><span class="s2">, is_fixed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">is_fixed</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Invalid attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,))</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">; prior=</span><span class="si">%s</span><span class="s1">, range=</span><span class="si">%s</span><span class="s1">, is_fixed=</span><span class="si">%s</span><span class="s1">,&#39;</span> \
                <span class="s1">&#39; is_discrete=</span><span class="si">%s</span><span class="s1">; help=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_discrete</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">)</span>

<div class="viewcode-block" id="Param.validate_value">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.validate_value">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_discrete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Param </span><span class="si">%s</span><span class="s1"> has a value </span><span class="si">%s</span><span class="s1"> which is not in the range of &#39;</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value_not_big_enough</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
                <span class="n">value_not_small_enough</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_not_big_enough</span> <span class="ow">or</span> <span class="n">value_not_small_enough</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Param </span><span class="si">%s</span><span class="s1"> has a value </span><span class="si">%s</span><span class="s1"> which is not in the range of &#39;</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
                    <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># Strings, bools, and `None` are simply used as-is; otherwise, enforce</span>
        <span class="c1"># input have units (or default to units of `dimensionless`)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">string_types</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))):</span>
            <span class="c1"># A number with no units actually has units of &quot;dimensionless&quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">interpret_quantity</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expect_sequence</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">),</span> \
                        <span class="s1">&#39;Passed values must have units if the param has units&#39;</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;dimensionless&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">magnitude</span>

<div class="viewcode-block" id="Param.m_as">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.m_as">[docs]</a>
    <span class="k">def</span> <span class="nf">m_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">u</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">dimensionality</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">)</span>

    <span class="nd">@range</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must provide a lower and upper bound; got </span><span class="si">{}</span><span class="s2"> value(s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The second value of the range must be strictly larger than the first.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A parameter with log-scaling must have a range that is &quot;</span>
                <span class="s2">&quot;either entirely negative or entirely positive.&quot;</span><span class="p">)</span>

        <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">interpret_quantity</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expect_sequence</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># NOTE: intentionally using type() instead of isinstance() here.</span>
            <span class="c1"># Not sure if this could be converted to isinstance(), though.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Value &quot;</span><span class="si">%s</span><span class="s1">&quot; has type </span><span class="si">%s</span><span class="s1"> but must be of type&#39;</span>
                                <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">!=</span> <span class="n">val</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value &quot;</span><span class="si">%s</span><span class="s1">&quot; units &quot;</span><span class="si">%s</span><span class="s1">&quot; incompatible with&#39;</span>
                                     <span class="s1">&#39; units &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>

            <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="n">new_vals</span>

    <span class="c1"># TODO: make discrete values rescale to integers 0, 1, ...</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_rescaled_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_discrete</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">srange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span>
        <span class="k">if</span> <span class="n">srange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot rescale without a range specified&#39;</span>
                             <span class="s1">&#39; for parameter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">srange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span>
        <span class="n">srange0</span> <span class="o">=</span> <span class="n">srange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
        <span class="n">srange1</span> <span class="o">=</span> <span class="n">srange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srange0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># entire range assumed negative (asserted elsewhere)</span>
                <span class="n">srange0</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">srange1</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">value</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">srange0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">srange1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">srange0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">srange0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">srange1</span> <span class="o">-</span> <span class="n">srange0</span><span class="p">)</span>

    <span class="nd">@_rescaled_value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_rescaled_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rval</span><span class="p">):</span>
        <span class="n">srange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span>
        <span class="k">if</span> <span class="n">srange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot rescale without a range specified&#39;</span>
                             <span class="s1">&#39; for parameter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rval</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">FTYPE_PREC</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: `rval`=</span><span class="si">%.15e</span><span class="s1">, but cannot be outside [0, 1]&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rval</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="n">rval</span><span class="p">])</span>  <span class="c1"># make exactly 1. if rounding error occurred</span>
        <span class="n">srange0</span> <span class="o">=</span> <span class="n">srange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
        <span class="n">srange1</span> <span class="o">=</span> <span class="n">srange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span><span class="p">:</span>
            <span class="c1"># it is possible that the entire value range is negative, taking the</span>
            <span class="c1"># absolute value only inside log() produces the correct sign</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rval</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">srange1</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">srange0</span><span class="p">))))</span> <span class="o">*</span> <span class="n">srange0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">srange0</span> <span class="o">+</span> <span class="p">(</span><span class="n">srange1</span> <span class="o">-</span> <span class="n">srange0</span><span class="p">)</span><span class="o">*</span><span class="n">rval</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>
        <span class="c1"># In some rare cases (one case being rval = 1., range = (-0.5, 0.3)), a rounding</span>
        <span class="c1"># error can occur that sets the value outside the allowed range. We clip the</span>
        <span class="c1"># value back to the range if that happens.</span>
        <span class="c1"># Using the standard setter method instead of writing to _value so that we</span>
        <span class="c1"># auto-convert in case the range is defined in different units.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">srange</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">srange</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">srange</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">srange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;{\rm </span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nominal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nominal_value</span>

    <span class="nd">@nominal_value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nominal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">string_types</span><span class="p">))):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">interpret_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expect_sequence</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nominal_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span>

    <span class="nd">@prior</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Prior</span><span class="p">):</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unhandled prior type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">=</span> <span class="n">prior</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_attrs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">state</span>
            <span class="n">setitem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serializable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>

<div class="viewcode-block" id="Param.reset">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the parameter&#39;s value to its nominal value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_value</span></div>


<div class="viewcode-block" id="Param.set_nominal_to_current_value">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.set_nominal_to_current_value">[docs]</a>
    <span class="k">def</span> <span class="nf">set_nominal_to_current_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the nominal value to the parameter&#39;s current value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="Param.randomize">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.randomize">[docs]</a>
    <span class="k">def</span> <span class="nf">randomize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize the parameter&#39;s value according to a uniform random</span>
<span class="sd">        distribution within the parameter&#39;s defined limits.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        random_state : None, int, or RandomState</span>
<span class="sd">            Object to use for random state. None defaults to the global random</span>
<span class="sd">            state (this is discouraged, as results are not reproducible). An</span>
<span class="sd">            integer acts as a seed to `numpy.random.seed()`, and RandomState is</span>
<span class="sd">            a `numpy.random.RandomState` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">random</span> <span class="o">=</span> <span class="n">get_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">=</span> <span class="n">rand</span></div>


<div class="viewcode-block" id="Param.prior_penalty">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.prior_penalty">[docs]</a>
    <span class="k">def</span> <span class="nf">prior_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the prior penalty according to `metric`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric : str</span>
<span class="sd">            Metric to use for evaluating the prior penalty.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        penalty : float prior penalty value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALL_METRICS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Metric &quot;</span><span class="si">%s</span><span class="s1">&quot; is invalid; must be one of </span><span class="si">%s</span><span class="s1">&#39;</span>
                             <span class="o">%</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">ALL_METRICS</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">LLH_METRICS</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;self.value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;self.prior: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">llh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">CHI2_METRICS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">chi2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized `metric` &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span></div>


<div class="viewcode-block" id="Param.to">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.to">[docs]</a>
    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span> <span class="c1"># pylint: disable=invalid-name</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an equivalent copy of param but in units of `units`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : string or pint.Unit</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Param : copy of this param, but in specified `units`.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        ito</span>
<span class="sd">        Pint.to</span>
<span class="sd">        Pint.ito</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_param</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="o">**</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="n">new_param</span><span class="o">.</span><span class="n">ito</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_param</span></div>


<div class="viewcode-block" id="Param.ito">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.ito">[docs]</a>
    <span class="k">def</span> <span class="nf">ito</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this param (in place) to have units of `units`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : string or pint.Unit</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        to</span>
<span class="sd">        Pint.to</span>
<span class="sd">        Pint.ito</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">ito</span><span class="p">(</span><span class="n">units</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prior_llh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;prior_llh is deprecated, please use prior_penalty(metric=&#39;llh&#39;) directly&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prior_chi2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;prior_chi2 is deprecated, please use prior_penalty(metric=&#39;chi2&#39;) directly&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int : hash of full state&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="n">normQuant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

<div class="viewcode-block" id="Param.to_json">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.to_json">[docs]</a>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize the state to a JSON file that can be instantiated as a new</span>
<span class="sd">        object later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jsons</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Param.from_json">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.Param.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a new Param from a JSON file&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">jsons</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="DerivedParam">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.DerivedParam">[docs]</a>
<span class="k">class</span> <span class="nc">DerivedParam</span><span class="p">(</span><span class="n">Param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta-parameter param that implements a param depending on other Params. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_slots</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unique_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_fixed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_discrete&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scales_as_log&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_rescaled_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;help&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_units&#39;</span><span class="p">,</span>
        <span class="s1">&#39;normalize_values&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_depends_names&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_dependson&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_configured&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_callable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dependson&#39;</span><span class="p">,</span>
        <span class="s1">&#39;callable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;depends_names&#39;</span>
    <span class="p">)</span>

    <span class="n">_state_attrs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unique_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;range&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_fixed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_discrete&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scales_as_log&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;help&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dependson&#39;</span><span class="p">,</span>
        <span class="s1">&#39;callable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;depends_names&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">name</span><span class="p">,</span> 
            <span class="n">value</span><span class="p">,</span> 
            <span class="n">unique_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">scales_as_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">nominal_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">tex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">depends_names</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">function_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_depends_names</span> <span class="o">=</span> <span class="n">depends_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependson</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callable</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nominal_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scales_as_log</span> <span class="o">=</span> <span class="n">scales_as_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="nb">range</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">unique_id</span> <span class="k">if</span> <span class="n">unique_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tex</span> <span class="o">=</span> <span class="n">tex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="n">help</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_discrete</span> <span class="o">=</span> <span class="n">is_discrete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">nominal_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nominal_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">function_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callable</span> <span class="o">=</span> <span class="n">Funct</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">find_resource</span><span class="p">(</span><span class="n">function_file</span><span class="p">))</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">callable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">callable</span><span class="o">.</span><span class="n">Funct</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;No set callable for DerivedParam </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callable</span>

    <span class="nd">@callable</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">:</span><span class="s1">&#39;callable.Funct&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Note - the callable should take dictionary of parameters</span>
<span class="sd">            {</span>
<span class="sd">                paramname:Param,</span>
<span class="sd">                paramname2:Param</span>
<span class="sd">            }</span>

<span class="sd">            the names are in principle redundant, but by keeping the mapping we can make the lookup of the dependable names quicker </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callable</span> <span class="o">=</span> <span class="n">what</span>
    
<div class="viewcode-block" id="DerivedParam.validate_value">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.DerivedParam.validate_value">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> </div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="c1"># if this is not re-implemented, the setter gets very confused </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">)</span>

    <span class="nd">@range</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        trust that this is set accurately </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="n">values</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">depends_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depends_names</span>

    <span class="nd">@depends_names</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">depends_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depends_names</span> <span class="o">=</span> <span class="n">names</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependson</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="s1">&#39;dict[Param]&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Cannot access unconfigured Derived parameter!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependson</span>

<div class="viewcode-block" id="DerivedParam.prior_penalty">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.DerivedParam.prior_penalty">[docs]</a>
    <span class="k">def</span> <span class="nf">prior_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            We don&#39;t want to double-count the penalty from derived params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>


    <span class="nd">@dependson</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dependson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">working</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Param</span><span class="p">):</span>
                <span class="n">working</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unhandled type </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">param</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependson</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">working</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depends_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">working</span><span class="p">])</span>


    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The value of this Derived Parameter is determined by calling the configured &#39;callable&#39; with the parameters it depends on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">dependson</span><span class="p">)</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="n">statekind</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;callable&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;depends&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">depends_names</span><span class="p">,</span>
            <span class="s2">&quot;range&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">statekind</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serializable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>

<div class="viewcode-block" id="DerivedParam.from_state">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.DerivedParam.from_state">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_state</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span><span class="o">-&gt;</span><span class="s1">&#39;DerivedParam&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DerivedParam.to_json">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.DerivedParam.to_json">[docs]</a>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">jsons</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>


<span class="c1"># TODO: temporary modification of parameters via &quot;with&quot; syntax?</span>
<span class="c1"># TODO: union, |, intersection, &amp;, difference, -, symmetric_difference, ^, copy</span>
<div class="viewcode-block" id="ParamSet">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet">[docs]</a>
<span class="k">class</span> <span class="nc">ParamSet</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Container class for a set of parameters. Most methods are passed</span>
<span class="sd">    through to contained params.</span>

<span class="sd">    Interface is a superset of both `MutableSequence` (i.e., behaves like a</span>
<span class="sd">    Python `list`, so ordering, appending, extending, etc. all work) and `Set`</span>
<span class="sd">    (i.e., behaves like a Python `set`, so no duplicates (tested by name) are</span>
<span class="sd">    allowed, you can test set membership like issuperset, issubset, etc.).</span>
<span class="sd">    See .. ::</span>

<span class="sd">        https://docs.python.org/3/library/collections.abc.html</span>

<span class="sd">    for the definitions of the `MutableSequence` and `Set` interfaces.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : one or more Param objects or sequences thereof</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pisa import ureg</span>
<span class="sd">    &gt;&gt;&gt; from pisa.core.prior import Prior</span>

<span class="sd">    &gt;&gt;&gt; e_prior = Prior(kind=&#39;gaussian&#39;, mean=10*ureg.GeV, stddev=1*ureg.GeV)</span>
<span class="sd">    &gt;&gt;&gt; cz_prior = Prior(kind=&#39;uniform&#39;, llh_offset=-5)</span>
<span class="sd">    &gt;&gt;&gt; reco_energy = Param(name=&#39;reco_energy&#39;, value=12*ureg.GeV,</span>
<span class="sd">    ...                     prior=e_prior, range=[1, 80]*ureg.GeV,</span>
<span class="sd">    ...                     is_fixed=False, is_discrete=False,</span>
<span class="sd">    ...                     tex=r&#39;E^{\rm reco}&#39;)</span>
<span class="sd">    &gt;&gt;&gt; reco_coszen = Param(name=&#39;reco_coszen&#39;, value=-0.2, prior=cz_prior,</span>
<span class="sd">    ...                     range=[-1, 1], is_fixed=True, is_discrete=False,</span>
<span class="sd">    ...                     tex=r&#39;\cos\,\theta_Z^{\rm reco}&#39;)</span>
<span class="sd">    &gt;&gt;&gt; param_set = ParamSet(reco_energy, reco_coszen)</span>
<span class="sd">    &gt;&gt;&gt; print(param_set)</span>
<span class="sd">    reco_coszen=-2.0000e-01 reco_energy=+1.2000e+01 GeV</span>

<span class="sd">    &gt;&gt;&gt; print(param_set.free)</span>
<span class="sd">    reco_energy=+1.2000e+01 GeV</span>

<span class="sd">    &gt;&gt;&gt; print(param_set.reco_energy.value)</span>
<span class="sd">    12 gigaelectron_volt</span>

<span class="sd">    &gt;&gt;&gt; print([p.prior_penalty(metric=&#39;llh&#39;) for p in param_set])</span>
<span class="sd">    [-5.0, -2]</span>

<span class="sd">    &gt;&gt;&gt; print(param_set.priors_penalty(metric=&#39;llh&#39;))</span>
<span class="sd">    -7.0</span>

<span class="sd">    &gt;&gt;&gt; print(param_set.values_hash)</span>
<span class="sd">    3917547535160330856</span>

<span class="sd">    &gt;&gt;&gt; print(param_set.free.values_hash)</span>
<span class="sd">    -7121742559130813936</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=protected-access</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># Unpack the input args into a flat list of params</span>
        <span class="n">param_sequence_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg_num</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">Param</span><span class="p">)):</span>
                <span class="n">param_sequence_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">param_sequence_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Unhandled type </span><span class="si">{}</span><span class="s2">, arg #</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">arg_num</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">param_sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_sequence_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Param</span><span class="p">):</span>
                <span class="n">param_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unhandled type </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">param</span><span class="p">))</span>

        <span class="c1"># Disallow duplicated params</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_sequence</span><span class="p">]</span>
        <span class="n">unique_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">):</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="n">all_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate definitions found for param(s): &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">))</span>

        <span class="c1"># Elements of list must be Param type</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Param</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param_sequence</span><span class="p">]),</span> \
                <span class="s1">&#39;All params must be of type &quot;Param&quot;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">param_sequence</span>

        <span class="c1"># if we do not normalize, then the hash will change upon evaluating unit changes</span>
        <span class="c1"># I think because the changed units are cached in the object (Philipp)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_derived</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether or not this set contains a derived parameter </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DerivedParam</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serializable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">state</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;presto&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ParamSet.tabulate">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.tabulate">[docs]</a>
    <span class="k">def</span> <span class="nf">tabulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;is_fixed&#39;</span><span class="p">]</span>
        <span class="n">colalign</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">string_types</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">nominal_value</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">range_fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">m</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">range</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">range_fmt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                        <span class="n">prior_fmt</span> <span class="o">=</span> <span class="s2">&quot;+/- </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">p</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">m</span>
                    <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
                        <span class="n">prior_fmt</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prior_fmt</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prior_fmt</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">prior</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">nominal_value</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">range_fmt</span><span class="p">,</span> <span class="n">prior_fmt</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Empty Params&quot;</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">,</span> <span class="n">colalign</span><span class="o">=</span><span class="n">colalign</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.index">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.index">[docs]</a>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># pylint: disable=arguments-differ</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an integer index to the Param in this ParamSet indexed by</span>
<span class="sd">        `value`. This does not look up a param&#39;s `value` property but looks for</span>
<span class="sd">        param by name, integer index, or matching object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : int, str or Param</span>
<span class="sd">            The object to return an index for. If int, the integer is returned</span>
<span class="sd">            (so long as it&#39;s in the valid range). If str, return index of param</span>
<span class="sd">            with matching `name` attribute. If Param object, return index of an</span>
<span class="sd">            equivalent Param in this set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        idx : int index to a corresponding param in this ParamSet</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : if `value` does not correspond to a param in this ParamSet</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found in ParamSet&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">idx</span></div>


<div class="viewcode-block" id="ParamSet.add_covariance">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.add_covariance">[docs]</a>
    <span class="k">def</span> <span class="nf">add_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covmat</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Correlates several Params. </span>
<span class="sd">            It works by taking the existing params, and rotating them into a new, uncorrelated, basis state. </span>
<span class="sd">            New parameters are added in the new basis, and the old params are replaced with derived params</span>
<span class="sd">            The fits therefore are done in the uncorrelated basis </span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covmat : dict</span>
<span class="sd">            A two-deep nested dictionary for covariances between Params</span>
<span class="sd">            Note: this is specifically not a 2D array such as to be explicit about which params are used</span>

<span class="sd">        ex:</span>
<span class="sd">        { </span>
<span class="sd">        Param1:{</span>
<span class="sd">            Param1: 0.9,</span>
<span class="sd">            Param2: 0.1 },</span>
<span class="sd">        Param2:{</span>
<span class="sd">            Param1:0.1,</span>
<span class="sd">            Param2:0.8}</span>
<span class="sd">        }</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError if given dict has keys not not shared with Parameter names </span>
<span class="sd">        TypeError if a given entry in covmat is not the proper type</span>
<span class="sd">        NotImplementedError if the means of calculating the mean for a given parameters prior isn&#39;t there yet </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covmat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">dim</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> 

        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span>
        <span class="k">for</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">covmat</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">{}</span><span class="s2"> not in Params&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covmat</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Each entry in covmat should be another dict, found </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">covmat</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
            <span class="k">for</span> <span class="n">k_j</span><span class="p">,</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">covmat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">subkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">{}</span><span class="s2"> not in Params&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subkey</span><span class="p">))</span>

                <span class="n">cov</span><span class="p">[</span><span class="n">k_i</span><span class="p">][</span><span class="n">k_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covmat</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Covariance matrix *must* be positive definite!&quot;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">covmat</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

        <span class="c1"># we need the mean values of the paramters</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">mean</span>
            <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">kind</span><span class="o">==</span><span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
                <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="c1"># diagonalize covariance matrix</span>
        <span class="n">evals</span><span class="p">,</span> <span class="n">inv_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span> 
        <span class="n">new_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-20</span> <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">new_sigmas</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found zero-width param </span><span class="si">{}</span><span class="s2"> - your parameters might be linearly dependent!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_sigmas</span><span class="p">))</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Let &quot;x&quot; be in the correlated basis</span>
<span class="sd">        and &quot;v&quot; be in the uncorrelated basis</span>

<span class="sd">        T is the matrix from `inv_t`</span>

<span class="sd">        v = (x - mu_x) @ T</span>
<span class="sd">        x = v@(T^-1) + mu_x  </span>

<span class="sd">        The new Parameters will have Gaussian priors centered at zero! </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">transformation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">inv_t</span><span class="p">)</span>
        <span class="n">ranges_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">range</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span> <span class="c1"># ranges in correlated basis</span>
        <span class="n">new_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">new_prior</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">stddev</span> <span class="o">=</span> <span class="n">new_sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># find max and min for this parameter</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                This paramter V is a function of \vec{x}=(x1, x2, x3, ...)</span>

<span class="sd">                \vec{v}_{i} can be calculated via summing over i </span>
<span class="sd">                    v_i = inv_t[j][i] x_i</span>

<span class="sd">                This is a linear transformation using the eivenvectors of the covariance matrix</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">v_max</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">v_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span> <span class="c1"># number of paramters, dimensionality </span>
                <span class="n">v_max</span> <span class="o">+=</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ranges_x</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">if</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ranges_x</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> 
                <span class="n">v_min</span> <span class="o">+=</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ranges_x</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">if</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">inv_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ranges_x</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> 

            <span class="n">new</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_rotated&quot;</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span> <span class="c1"># get the centers. These will be zero since we subtract the mean</span>
                <span class="n">prior</span> <span class="o">=</span> <span class="n">new_prior</span><span class="p">,</span>
                <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">),</span>
                <span class="n">is_fixed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">is_discrete</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">scales_as_log</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">scales_as_log</span><span class="p">,</span>
                <span class="n">nominal_value</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
                <span class="n">tex</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">tex</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span>
            <span class="p">)</span>

            <span class="n">new_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="c1"># add in this new parameter </span>

        <span class="k">def</span> <span class="nf">build_func</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">all_vars</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">callable</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">new_par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">new_par</span> <span class="ow">in</span> <span class="n">new_parameters</span> <span class="p">]</span>

            <span class="n">function</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">all_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">_i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">function</span> <span class="o">=</span> <span class="n">function</span> <span class="o">+</span> <span class="n">transformation</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">all_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">function</span> <span class="o">=</span> <span class="n">function</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">function</span>

        <span class="c1"># now that we have constructed the new parameters, update the old ones to be DerivedParams</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">derived_version</span> <span class="o">=</span> <span class="n">DerivedParam</span><span class="p">(</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">range</span>
            <span class="p">)</span>
            <span class="n">derived_version</span><span class="o">.</span><span class="n">dependson</span> <span class="o">=</span> <span class="n">new_parameters</span> <span class="c1"># depends on the parameters we&#39;ve just set up in the uncorrelated basis</span>
            <span class="n">derived_version</span><span class="o">.</span><span class="n">callable</span> <span class="o">=</span> <span class="n">build_func</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">derived_version</span><span class="p">)</span></div>


            


<div class="viewcode-block" id="ParamSet.replace">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.replace">[docs]</a>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace an existing param with `new` param, where the existing param</span>
<span class="sd">        must have the same `name` attribute as `new`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new : Param</span>
<span class="sd">            New param to use instead of current param.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : if `new.name` does not match an existing param&#39;s name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span></div>


<div class="viewcode-block" id="ParamSet.set_values">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.set_values">[docs]</a>
    <span class="k">def</span> <span class="nf">set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set values in current ParamSet to those defined in new ParamSet</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_params : ParamSet</span>
<span class="sd">            ParamSet containing set of values to change current ParamSet to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">!=</span> <span class="n">new_params</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ParamSet names do not match. Currently have </span><span class="si">%s</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;and want to change to a set containing </span><span class="si">%s</span><span class="s1">.&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">new_params</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">new_param</span> <span class="ow">in</span> <span class="n">new_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">new_param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_param</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="ParamSet.fix">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.fix">[docs]</a>
    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set param(s) to be fixed in value (and hence not modifiable by e.g.</span>
<span class="sd">        a minimizer).</span>

<span class="sd">        Note that the operation is atomic: If `x` is a sequence of indexing</span>
<span class="sd">        objects, if _any_ index in `x` cannot be found, _no_ other params</span>
<span class="sd">        specified in `x` will be set to be fixed.</span>

<span class="sd">        Any params specified in `x` that are already fixed simply remain so.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : int, str, Param, or iterable thereof</span>
<span class="sd">            Object or sequence to index into params to define which to affix.</span>
<span class="sd">            See `index` method for valid objects to use for indexing into the</span>
<span class="sd">            ParamSet.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : if any index cannot be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">Param</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">is_fixed</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ParamSet.unfix">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.unfix">[docs]</a>
    <span class="k">def</span> <span class="nf">unfix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set param(s) to be free (and hence  modifiable by e.g. a minimizer).</span>

<span class="sd">        Note that the operation is atomic: If `x` is a sequence of indexing</span>
<span class="sd">        objects, if _any_ index in `x` cannot be found, _no_ other params</span>
<span class="sd">        specified in `x` will be set to be free.</span>

<span class="sd">        Any params specified in `x` that are already free simply remain so.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : int, str, Param, or iterable thereof</span>
<span class="sd">            Object or sequence to index into params to define which to affix.</span>
<span class="sd">            See `index` method for valid objects to use for indexing into the</span>
<span class="sd">            ParamSet.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : if any index cannot be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">Param</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">is_fixed</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ParamSet.update">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update this param set using `obj`.</span>

<span class="sd">        Default behavior is similar to Python&#39;s dict.update, but this can be</span>
<span class="sd">        modified via `existing_must_match` and `extend`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : Param, ParamSet, or sequence thereof</span>
<span class="sd">            Param or container with params to update and/or extend this param</span>
<span class="sd">            set</span>
<span class="sd">        existing_must_match : bool</span>
<span class="sd">            If True, raises ValueError if param values passed in that already</span>
<span class="sd">            exist in this param set have differing values.</span>
<span class="sd">        extend : bool</span>
<span class="sd">            If True, params not in this param set are appended.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure we&#39;re having a new object!</span>
        <span class="c1">#obj = deepcopy(obj)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">ParamSet</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="n">existing_must_match</span><span class="p">,</span>
                            <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Param</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`obj`=&quot;</span><span class="si">%s</span><span class="s1">&quot; is not a Param&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">existing_must_match</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Param &quot;</span><span class="si">%s</span><span class="s1">&quot; specified as</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">contradicts&#39;</span>
                    <span class="s1">&#39; internally-stored version:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">extend</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.insert">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.insert">[docs]</a>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert value before index&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Param</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`value` must be a Param; got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot insert an existing param name: &#39;</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.extend">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.extend">[docs]</a>
    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append param(s) in `values` to this param set, but ensure params in</span>
<span class="sd">        `values` that are already in this param set match. Params with same name</span>
<span class="sd">        attribute are not duplicated.</span>

<span class="sd">        (Convenience method or calling `update` method with</span>
<span class="sd">        existing_must_match=True and extend=True.)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.update_existing">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.update_existing">[docs]</a>
    <span class="k">def</span> <span class="nf">update_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Only existing params in this set are updated by that(those) param(s)</span>
<span class="sd">        in obj.</span>

<span class="sd">        Convenience method for calling `update` with</span>
<span class="sd">        existing_must_match=False and extend=False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Param</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Cannot index into a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">t</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">param_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># `attr` (should be) param name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Param</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">val</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">attr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isbarenumeric</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set param &quot;</span><span class="si">%s</span><span class="s1">&quot; to `val`=</span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="o">%</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%+.4e</span><span class="s1">&#39;</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">numfmt</span> <span class="o">%</span><span class="n">p</span><span class="o">.</span><span class="n">m</span>
                <span class="n">full_unit_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">full_unit_str</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ureg</span><span class="p">(</span><span class="s1">&#39;electron_volt ** 2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">u</span><span class="p">)]:</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; eV2&#39;</span>
                <span class="k">elif</span> <span class="n">full_unit_str</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ureg</span><span class="o">.</span><span class="n">deg</span><span class="p">)]:</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; deg&#39;</span>
                <span class="k">elif</span> <span class="n">full_unit_str</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ureg</span><span class="o">.</span><span class="n">rad</span><span class="p">)]:</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; rad&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;~&#39;</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">unit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="n">numfmt</span> <span class="o">%</span><span class="n">p</span><span class="o">.</span><span class="n">value</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">p</span><span class="o">.</span><span class="n">value</span>
            <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="ParamSet.issubset">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.issubset">[docs]</a>
    <span class="k">def</span> <span class="nf">issubset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">param</span> <span class="ow">in</span> <span class="n">other</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.issuperset">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.issuperset">[docs]</a>
    <span class="k">def</span> <span class="nf">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">other</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__leq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__geq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="ParamSet.priors_penalty">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.priors_penalty">[docs]</a>
    <span class="k">def</span> <span class="nf">priors_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the aggregate prior penalty for all params at their current</span>
<span class="sd">        values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric : str</span>
<span class="sd">            Metric to use for evaluating the prior.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        penalty : float sum of all parameters&#39; prior values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if daemonflux stage is not used use std priors penalty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;daemon_chi2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">priors_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span> 
                                 <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">])</span>

        <span class="c1"># else switch daemon flux params penalty to the one drom daemonflux</span>
        <span class="c1"># (which takes into account covariance)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># normal (non-correlated) penalty for non-daemonflux params</span>
            <span class="n">priors_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="s2">&quot;daemon_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

            <span class="c1"># conversion factor between chi2 and llh</span>
            <span class="n">conv_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">LLH_METRICS</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="c1"># add daemonflux calcualted chi2 penalty</span>
            <span class="n">priors_sum</span> <span class="o">+=</span> <span class="n">conv_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">[</span><span class="s2">&quot;daemon_chi2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="s2">&quot;dimensionless&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">priors_sum</span></div>


<div class="viewcode-block" id="ParamSet.priors_penalties">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.priors_penalties">[docs]</a>
    <span class="k">def</span> <span class="nf">priors_penalties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the prior penalties for each param at their current values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric : str</span>
<span class="sd">            Metric to use for evaluating the prior.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        penalty : list of float prior values, one for each param</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">]</span></div>


<div class="viewcode-block" id="ParamSet.reset_all">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.reset_all">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset both free and fixed parameters to their nominal values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_values</span></div>


<div class="viewcode-block" id="ParamSet.reset_free">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.reset_free">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset only free parameters to their nominal values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">reset_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="ParamSet.set_nominal_by_current_values">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.set_nominal_by_current_values">[docs]</a>
    <span class="k">def</span> <span class="nf">set_nominal_by_current_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the nominal values as the parameters&#39; current values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>


<div class="viewcode-block" id="ParamSet.randomize_free">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.randomize_free">[docs]</a>
    <span class="k">def</span> <span class="nf">randomize_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize any free parameters with according to a uniform random</span>
<span class="sd">        distribution within the parameters&#39; defined limits.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        random_state : None, int, or RandomState</span>
<span class="sd">            Object to use for random state. None defaults to the global random</span>
<span class="sd">            state (this is discouraged, as results are not reproducible). An</span>
<span class="sd">            integer acts as a seed to `numpy.random.seed()`, and RandomState is</span>
<span class="sd">            a `numpy.random.RandomState` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">random</span> <span class="o">=</span> <span class="n">get_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">)</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">_rescaled_values</span> <span class="o">=</span> <span class="n">rand</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_rescaled_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parameter values rescaled to be in the range [0, 1], based upon</span>
<span class="sd">        their defined range.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@_rescaled_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_rescaled_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
            <span class="n">param</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;,\;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="n">tex</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ParamSet</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ParamSet</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ParamSet</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_discrete</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ParamSet</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_discrete</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">are_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">is_fixed</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">are_discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">is_discrete</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name_val_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_nominal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([(</span><span class="n">v0</span> <span class="o">==</span> <span class="n">v1</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">)])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nominal_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">nominal_value</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">]</span>

    <span class="nd">@nominal_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nominal_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;nominal_value&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">prior</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@priors</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priors_llh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;priors_llh is deprecated, please use priors_penalty(metric=&#39;llh&#39;) instead&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priors_chi2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;priors_chi2 is deprecated, please use priors_penalty(metric=&#39;chi2&#39;) instead&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">range</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@ranges</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int : hash only on the current param values (not full state)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="n">normQuant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nominal_values_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int : hash only on the nominal param values&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="n">normQuant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int : full state hash&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="n">normQuant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

<div class="viewcode-block" id="ParamSet.to_json">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.to_json">[docs]</a>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize the state to a JSON file that can be instantiated as a new</span>
<span class="sd">        object later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jsons</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSet.from_json">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSet.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a new ParamSet from a JSON file&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">jsons</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Unhandled type loaded from &quot;</span><span class="si">{}</span><span class="s1">&quot;: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state</span>
            <span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ParamSelector">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSelector">[docs]</a>
<span class="k">class</span> <span class="nc">ParamSelector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regular_params : ParamSet or instantiable thereto</span>

<span class="sd">    selector_param_sets : None, dict, or sequence of dict</span>
<span class="sd">        Dict(s) format:</span>
<span class="sd">            {</span>
<span class="sd">              &#39;&lt;name1&gt;&#39;: &lt;ParamSet or instantiable thereto&gt;,</span>
<span class="sd">              &#39;&lt;name2&gt;&#39;: &lt;ParamSet or instantiable thereto&gt;,</span>
<span class="sd">              ...</span>
<span class="sd">            }</span>
<span class="sd">        The names are what must be specified in `selections` to select the</span>
<span class="sd">        corresponding ParamSets. Params specified in any of the ParamSets</span>
<span class="sd">        within `selector_param_sets cannot be in `regular_params`.</span>

<span class="sd">    selections : None, string, or sequence of strings</span>
<span class="sd">        One string is required per</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Params specified in `regular_params` are enforced to be mutually exclusive</span>
<span class="sd">    with params in the param sets specified by `selector_param_sets`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=protected-access</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regular_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selector_param_sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">selections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regular_params</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">regular_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">regular_params</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector_param_sets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selector</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">selector_param_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="n">selections</span><span class="o">=</span><span class="n">selections</span><span class="p">,</span> <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="ParamSelector.select_params">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSelector.select_params">[docs]</a>
    <span class="k">def</span> <span class="nf">select_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="n">selections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">,</span>
                                      <span class="n">error_on_missing</span><span class="o">=</span><span class="n">error_on_missing</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selections</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">selections</span> <span class="o">=</span> <span class="n">selections</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selections</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>

        <span class="n">distilled_selections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Selection should be a str. Got </span><span class="si">%s</span><span class="s2"> instead.&quot;</span><span class="o">%</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="s1">&#39;No selection &quot;</span><span class="si">%s</span><span class="s1">&quot; available; valid selections are </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="s1">&#39; (case-insensitive).&#39;</span>
                        <span class="o">%</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">error_on_missing</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">distilled_selections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">distilled_selections</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_selections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_selections</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regular_params</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_regular_params</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ParamSelector.update">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSelector.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not instantiate a ParamSet with `p` of type&#39;</span>
                          <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">, value = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regular_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="n">existing_must_match</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="n">existing_must_match</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="n">existing_must_match</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">selector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">existing_must_match</span><span class="o">=</span><span class="n">existing_must_match</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>

            <span class="c1"># Re-select current selectiosn in case the update modifies these</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="n">error_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamSelector.get">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.ParamSelector.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regular_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector_params</span><span class="p">[</span><span class="n">selector</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regular_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="test_Param">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.test_Param">[docs]</a>
<span class="k">def</span> <span class="nf">test_Param</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for Param class&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-variable</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">splrep</span>
    <span class="kn">from</span> <span class="nn">pisa.utils.comparisons</span> <span class="kn">import</span> <span class="n">ALLCLOSE_KW</span>

    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">check_json</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;foo</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">param</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="n">Param</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">recursiveEquality</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">loaded</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">,</span> <span class="n">loaded</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: failed to save / load identical param:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;original = </span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;loaded   = </span><span class="si">{:s}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">loaded</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_scaling</span><span class="p">(</span><span class="n">p0</span><span class="p">):</span>
        <span class="n">value_prescale</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># calculate rescaled value that is used by the minimizer, make sure</span>
        <span class="c1"># the original value can be recovered</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">=</span> <span class="n">rval</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;value of param </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> after re-scaling is </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;should be </span><span class="si">{</span><span class="n">value_prescale</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">value_prescale</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="o">**</span><span class="n">ALLCLOSE_KW</span>
        <span class="p">),</span> <span class="n">msg</span>
        <span class="c1"># check nothing breaks when we go to the edges</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">==</span> <span class="mf">0.</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">==</span> <span class="mf">1.</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value_prescale</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;value of param </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> after re-scaling is </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;should be </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="o">**</span><span class="n">ALLCLOSE_KW</span>
        <span class="p">),</span> <span class="n">msg</span>
        <span class="c1"># We can afford rounding errors within the range, but we *cannot* afford them</span>
        <span class="c1"># outside of the range, so we test that here explicitly.</span>
        <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">p0</span><span class="o">.</span><span class="n">_rescaled_value</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;value of param </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> after re-scaling is </span><span class="si">{</span><span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;should be </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="o">**</span><span class="n">ALLCLOSE_KW</span>
        <span class="p">),</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">m_as</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">msg</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">uniform</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">llh_offset</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">gaussian</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span>
        <span class="n">param_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>
        <span class="n">llh_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_vals</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">linterp_m</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linterp&#39;</span><span class="p">,</span> <span class="n">param_vals</span><span class="o">=</span><span class="n">param_vals</span><span class="p">,</span> <span class="n">llh_vals</span><span class="o">=</span><span class="n">llh_vals</span><span class="p">)</span>
        <span class="n">linterp_nounits</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linterp&#39;</span><span class="p">,</span> <span class="n">param_vals</span><span class="o">=</span><span class="n">param_vals</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                <span class="n">llh_vals</span><span class="o">=</span><span class="n">llh_vals</span><span class="p">)</span>

        <span class="n">param_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">llh_vals</span> <span class="o">=</span> <span class="n">param_vals</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">knots</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">param_vals</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">llh_vals</span><span class="p">)</span>

        <span class="n">spline</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

        <span class="c1"># Param with units, prior with compatible units</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">5000</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">foot</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">gaussian</span><span class="p">,</span>
                   <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">mile</span><span class="p">,</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
        <span class="n">check_scaling</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">check_json</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="s2">&quot;p0&quot;</span><span class="p">)</span>

        <span class="c1"># Param with units, prior with compatible units, log-scaling behavior</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">5000</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">foot</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">gaussian</span><span class="p">,</span>
                   <span class="c1"># range entirely positive</span>
                   <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">mile</span><span class="p">,</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">scales_as_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
        <span class="n">check_scaling</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">check_json</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="s2">&quot;p0&quot;</span><span class="p">)</span>

        <span class="c1"># range entirely negative</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">5000</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">foot</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">gaussian</span><span class="p">,</span>
                   <span class="c1"># range entirely positive</span>
                   <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">]</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">mile</span><span class="p">,</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">scales_as_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
        <span class="n">check_scaling</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">check_json</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="s2">&quot;p0&quot;</span><span class="p">)</span>

        <span class="c1"># Test a pathological parameter with a range of (-0.5, 0.3) and try to set the</span>
        <span class="c1"># rescaled value to the upper boundary. This used to cause an error in the past</span>
        <span class="c1"># because (-0.5 + (0.3 -(-0.5)) * 1.) = 0.30000000000000004, which is above 0.3.</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                   <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">check_scaling</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">check_json</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="s2">&quot;p0&quot;</span><span class="p">)</span>

        <span class="c1"># Param with no units, prior with no units</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                   <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
        <span class="n">check_json</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="s2">&quot;p1&quot;</span><span class="p">)</span>

        <span class="c1"># Param with no units, prior with units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">linterp_m</span><span class="p">,</span>
                       <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">linterp_m</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;p2.units: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;p2.prior.units: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">DimensionalityError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="c1"># Param with units, prior with no units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                       <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">linterp_nounits</span><span class="p">,</span>
                       <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="c1"># Param, range, prior with no units</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">linterp_nounits</span><span class="p">,</span>
                   <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">)</span>

        <span class="c1"># Param, prior with no units, range with units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">linterp_nounits</span><span class="p">,</span>
                       <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">linterp_nounits</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;p2.units: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;p2.prior.units: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="n">nom0</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span>
        <span class="n">val0</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mf">1.01</span>
        <span class="n">val1</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">val0</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">val0</span> <span class="o">*</span> <span class="mf">1.01</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">nom0</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">==</span> <span class="n">nom0</span>

        <span class="n">p2</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">nom0</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">==</span> <span class="n">nom0</span>

        <span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val1</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">set_nominal_to_current_value</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">value</span>
        <span class="k">assert</span> <span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span> <span class="o">==</span> <span class="n">val1</span><span class="p">,</span> \
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> should be </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">nominal_value</span><span class="p">,</span> <span class="n">val1</span><span class="p">)</span>

        <span class="c1"># Test deepcopy</span>
        <span class="n">param2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">param2</span> <span class="o">==</span> <span class="n">p2</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_Param &gt;&gt;&#39;</span><span class="p">)</span></div>



<span class="c1"># TODO: add tests for reset() and reset_all() methods</span>
<div class="viewcode-block" id="test_ParamSet">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.test_ParamSet">[docs]</a>
<span class="k">def</span> <span class="nf">test_ParamSet</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for ParamSet class&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm a}&#39;</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;deleteme&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm dm}&#39;</span><span class="p">)</span>

    <span class="n">proto_param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="c1"># Membership tests</span>
    <span class="k">assert</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">proto_param_set</span>
    <span class="n">p0_mod</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
    <span class="n">p0_mod</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.6</span>
    <span class="k">assert</span> <span class="n">p0_mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">proto_param_set</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span> <span class="o">&lt;=</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">proto_param_set</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span> <span class="o">&gt;=</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">proto_param_set</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">proto_param_set</span><span class="p">)</span>

    <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">param_set</span> <span class="o">&gt;=</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">param_set</span> <span class="o">&gt;</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span> <span class="o">&lt;=</span> <span class="n">param_set</span>
    <span class="k">assert</span> <span class="n">proto_param_set</span> <span class="o">&lt;</span> <span class="n">param_set</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">del</span> <span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;deleteme&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.5</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="s1">&#39;deleteme&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_set</span><span class="o">.</span><span class="n">names</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>

    <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="k">del</span> <span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">proto_param_set</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.5</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="s1">&#39;deleteme&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_set</span><span class="o">.</span><span class="n">names</span>

    <span class="c1"># Test `remove`, `pop`, and `del` with param in any position</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>

        <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">param_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">proto_param_set</span>

        <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">param_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">p3</span>
        <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">proto_param_set</span>

        <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">param_set</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">proto_param_set</span>

    <span class="c1"># Test `insert`</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>
        <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

        <span class="n">params</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
        <span class="n">ref_param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

        <span class="n">param_set</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">param_set</span> <span class="o">==</span> <span class="n">ref_param_set</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>

    <span class="n">param_set</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">proto_param_set</span><span class="p">)</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;priors:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">priors</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;names:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">range</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">33</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;was able to set value outside of range&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">)))</span>
    <span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">unfix</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">unfix</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>

    <span class="n">fixed_params</span> <span class="o">=</span> <span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">fixed_params</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>
    <span class="n">free_params</span> <span class="o">=</span> <span class="n">param_set</span><span class="o">.</span><span class="n">free</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">free_params</span><span class="o">.</span><span class="n">are_fixed</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">values_hash</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">values_hash</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">values_hash</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">hash</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">hash</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">hash</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;fixed:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;fixed, discrete:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">discrete</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;fixed, continuous:&#39;</span><span class="p">,</span>
                       <span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;free:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;free, discrete:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">discrete</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;free, continuous:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;continuous, free:&#39;</span><span class="p">,</span> <span class="n">param_set</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;free, continuous hash:&#39;</span><span class="p">,</span>
                       <span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">values_hash</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="s1">&#39;continuous, free hash:&#39;</span><span class="p">,</span>
                       <span class="n">param_set</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">values_hash</span><span class="p">)))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">priors_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">priors_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">priors_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;llh&#39;</span><span class="p">))))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prior_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;chi2&#39;</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="o">.</span><span class="n">priors_penalty</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;chi2&#39;</span><span class="p">))))</span>

    <span class="c1"># Test that setting attributes works</span>
    <span class="n">e_prior</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span>
    <span class="n">cz_prior</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">llh_offset</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">reco_energy</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;reco_energy&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">12</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
                        <span class="n">prior</span><span class="o">=</span><span class="n">e_prior</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
                        <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;E^{\rm reco}&#39;</span><span class="p">)</span>
    <span class="n">reco_coszen</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;reco_coszen&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">cz_prior</span><span class="p">,</span>
                        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\cos\,\theta_Z^{\rm reco}&#39;</span><span class="p">)</span>
    <span class="n">reco_coszen_fail</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;reco_coszen_fail&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span>
                             <span class="n">prior</span><span class="o">=</span><span class="n">cz_prior</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\cos\,\theta_Z^{\rm reco}&#39;</span><span class="p">)</span>
    <span class="n">reco_coszen2</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;reco_coszen&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">cz_prior</span><span class="p">,</span>
                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\cos\,\theta_Z^{\rm reco}&#39;</span><span class="p">)</span>
    <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">([</span><span class="n">reco_energy</span><span class="p">,</span> <span class="n">reco_coszen</span><span class="p">])</span>
    <span class="c1"># Try setting a param with a differently-named param</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="n">reco_coszen_fail</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="n">reco_coszen2</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="ow">is</span> <span class="n">reco_coszen2</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="p">[</span><span class="s1">&#39;reco_coszen&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">reco_coszen2</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.9</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="s2">&quot;0.1 dimensionless&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_coszen</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">0.1</span> <span class="o">==</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="s2">&quot;0.1 dimensionless&quot;</span><span class="p">)</span>
    <span class="n">param_set</span><span class="o">.</span><span class="n">reco_energy</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="s2">&quot;10.1 GeV&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">param_set</span><span class="o">.</span><span class="n">reco_energy</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="s2">&quot;10.1 GeV&quot;</span><span class="p">)</span>

    <span class="c1"># Test deepcopy</span>
    <span class="n">param_set2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_set</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">param_set2</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">param_set2</span> <span class="o">==</span> <span class="n">param_set</span>

    <span class="c1"># Test case added as a result of issue #543</span>
    <span class="c1"># https://github.com/IceCubeOpenSource/pisa/issues/543</span>
    <span class="n">param_set</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param0&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
                <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param3&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">ureg</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">cm</span><span class="o">/</span><span class="n">ureg</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Param</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param4&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">2.1</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">ureg</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">*</span><span class="n">ureg</span><span class="o">.</span><span class="n">cm</span><span class="o">/</span><span class="n">ureg</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;foo.json&quot;</span><span class="p">)</span>
        <span class="n">param_set</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">param_set2</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">recursiveEquality</span><span class="p">(</span><span class="n">param_set</span><span class="p">,</span> <span class="n">param_set2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">recursiveEquality</span><span class="p">(</span>
        <span class="n">param_set</span><span class="o">.</span><span class="n">serializable_state</span><span class="p">,</span> <span class="n">param_set2</span><span class="o">.</span><span class="n">serializable_state</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_ParamSet &gt;&gt;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="test_ParamSelector">
<a class="viewcode-back" href="../../../pisa.core.html#pisa.core.param.test_ParamSelector">[docs]</a>
<span class="k">def</span> <span class="nf">test_ParamSelector</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for ParamSelector class&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init, no-member, invalid-name</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\int{\rm c}&#39;</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm a}&#39;</span><span class="p">)</span>
    <span class="n">p20</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p21</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p22</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p30</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p31</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p40</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p41</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">ps30_40</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">(</span><span class="n">p30</span><span class="p">,</span> <span class="n">p40</span><span class="p">)</span>
    <span class="n">param_selector</span> <span class="o">=</span> <span class="n">ParamSelector</span><span class="p">(</span>
        <span class="n">regular_params</span><span class="o">=</span><span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">],</span>
        <span class="n">selector_param_sets</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;p20&#39;</span><span class="p">:</span> <span class="n">p20</span><span class="p">,</span> <span class="s1">&#39;p21&#39;</span><span class="p">:</span> <span class="n">p21</span><span class="p">,</span> <span class="s1">&#39;p22&#39;</span><span class="p">:</span> <span class="n">p22</span><span class="p">,</span>
                             <span class="s1">&#39;p30_40&#39;</span><span class="p">:</span> <span class="n">ps30_40</span><span class="p">,</span> <span class="s1">&#39;p31_41&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p31</span><span class="p">,</span> <span class="n">p41</span><span class="p">]},</span>
        <span class="n">selections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p20&#39;</span><span class="p">,</span> <span class="s1">&#39;p30_40&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">params</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.5</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.5</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.5</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.5</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">15</span>

    <span class="c1"># Modify a param&#39;s value from the selector&#39;s params</span>
    <span class="n">params</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mf">1.8</span>
    <span class="c1"># Make sure that took</span>
    <span class="k">assert</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.8</span>
    <span class="c1"># Make sure the original param was also modified (i.e., that it&#39;s the exact</span>
    <span class="c1"># object that was populated to the param_selector&#39;s params)</span>
    <span class="k">assert</span> <span class="n">p20</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.8</span>

    <span class="n">param_selector</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="s1">&#39;p21&#39;</span><span class="p">)</span>
    <span class="c1"># Make sure &#39;c&#39; is changed using all ways to access &#39;c&#39;</span>
    <span class="k">assert</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.0</span>
    <span class="k">assert</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.0</span>
    <span class="k">assert</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.0</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.0</span>
    <span class="c1"># Make sure original params have values previous to selection</span>
    <span class="k">assert</span> <span class="n">p20</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.8</span>
    <span class="k">assert</span> <span class="n">p21</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">2.0</span>

    <span class="c1"># Change the newly-selected param&#39;s value</span>
    <span class="n">params</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mf">1.9</span>
    <span class="c1"># Make sure that took</span>
    <span class="k">assert</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.9</span>
    <span class="c1"># Make sure the original param was also modified (i.e., that it&#39;s the exact</span>
    <span class="c1"># object that was populated to the param_selector&#39;s params)</span>
    <span class="k">assert</span> <span class="n">p21</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.9</span>

    <span class="n">param_selector</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>
    <span class="k">assert</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">20</span>
    <span class="n">params</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="o">-</span><span class="mf">19.9</span>
    <span class="k">assert</span> <span class="n">p41</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mf">19.9</span>

    <span class="c1"># Test the update method</span>

    <span class="n">p5</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
               <span class="n">is_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p60</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p61</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>

    <span class="c1"># Update with a &quot;regular&quot; param that doesn&#39;t exist yet</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">120</span>

    <span class="c1"># Update with a new &quot;selector&quot; param with selector that&#39;s currently</span>
    <span class="c1"># selected</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p61</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>

    <span class="c1"># Update with a new &quot;selector&quot; param with selector that&#39;s _not_ currently</span>
    <span class="c1"># selected</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p60</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p30_40&#39;</span><span class="p">)</span>

    <span class="c1"># Selected param value shouldn&#39;t have changed</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>

    <span class="c1"># ... but the param should be in the object</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p30_40&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># ... and selecting it should now set current param to its value</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="s1">&#39;p30_40&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Double check that the other one didn&#39;t change</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>

    <span class="c1"># Use update to overwrite existing params...</span>

    <span class="n">p402</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">11</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>
    <span class="n">p412</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">22</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                 <span class="n">is_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;{\rm b}&#39;</span><span class="p">)</span>

    <span class="c1"># Update param that exists already and is selected</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p402</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p30_40&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">11</span>

    <span class="c1"># Make sure original param wasn&#39;t overwritten (just not in param_selector)</span>
    <span class="k">assert</span> <span class="n">p40</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">15</span>

    <span class="c1"># Update param that exists already but is not selected</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p412</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">11</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">param_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">22</span>
    <span class="n">param_selector</span><span class="o">.</span><span class="n">select_params</span><span class="p">(</span><span class="s1">&#39;p31_41&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">22</span>

    <span class="c1"># Test deepcopy</span>
    <span class="n">param_selector2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_selector</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">param_selector2</span> <span class="o">==</span> <span class="n">param_selector</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_ParamSelector &gt;&gt;&#39;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">set_verbosity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">test_Param</span><span class="p">()</span>
    <span class="n">test_ParamSet</span><span class="p">()</span>
    <span class="n">test_ParamSelector</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The IceCube/PINGU Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>