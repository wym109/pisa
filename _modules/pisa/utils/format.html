<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pisa.utils.format &mdash; PISA 4.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=9f5556dd"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PISA
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PISA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pisa.utils.format</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pisa.utils.format</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities for interpreting and returning formatted strings.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Integral</span><span class="p">,</span> <span class="n">Number</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">uncertainties</span>

<span class="kn">from</span> <span class="nn">pisa</span> <span class="kn">import</span> <span class="n">FTYPE</span><span class="p">,</span> <span class="n">ureg</span>
<span class="kn">from</span> <span class="nn">pisa.utils.flavInt</span> <span class="kn">import</span> <span class="n">NuFlavIntGroup</span>
<span class="kn">from</span> <span class="nn">pisa.utils.log</span> <span class="kn">import</span> <span class="n">Levels</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">set_verbosity</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;WHITESPACE_RE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUMBER_RESTR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUMBER_RE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HRGROUP_RESTR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HRGROUP_RE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IGNORE_CHARS_RE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TEX_BACKSLASH_CHARS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TEX_SPECIAL_CHARS_MAPPING&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SI_PREFIX_TO_ORDER_OF_MAG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ORDER_OF_MAG_TO_SI_PREFIX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BIN_PREFIX_TO_POWER_OF_1024&#39;</span><span class="p">,</span>
    <span class="s1">&#39;POWER_OF_1024_TO_BIN_PREFIX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;split&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arg_str_seq_none&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arg_to_tuple&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hr_range_formatter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_hr_range_formatter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;list2hrlist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_list2hrlist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hrlist2list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hrlol2lol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hrbool2bool&#39;</span><span class="p">,</span>
    <span class="s1">&#39;engfmt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;text2tex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tex_join&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tex_dollars&#39;</span><span class="p">,</span>
    <span class="s1">&#39;default_map_tex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_tex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;int2hex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hash2hex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;strip_outer_dollars&#39;</span><span class="p">,</span>
    <span class="s1">&#39;strip_outer_parens&#39;</span><span class="p">,</span>
    <span class="s1">&#39;make_valid_python_name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sep_three_tens&#39;</span><span class="p">,</span>
    <span class="s1">&#39;format_num&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_format_num&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timediff&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_timediff&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_timestamp&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;J.L. Lanfranchi&#39;</span>

<span class="n">__license__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;Copyright (c) 2014-2020, The IceCube Collaboration</span>

<span class="s1"> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s1"> you may not use this file except in compliance with the License.</span>
<span class="s1"> You may obtain a copy of the License at</span>

<span class="s1">   http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s1"> Unless required by applicable law or agreed to in writing, software</span>
<span class="s1"> distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s1"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s1"> See the License for the specific language governing permissions and</span>
<span class="s1"> limitations under the License.&#39;&#39;&#39;</span>


<span class="n">WHITESPACE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="p">)</span>
<span class="n">NUMBER_RESTR</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;((?:-|\+){0,1}[0-9.]+(?:e(?:-|\+)[0-9.]+){0,1})&#39;</span>
<span class="sd">&quot;&quot;&quot;RE str for matching signed, unsigned, and sci.-not. (&quot;1e10&quot;) numbers.&quot;&quot;&quot;</span>

<span class="n">NUMBER_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NUMBER_RESTR</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Regex for matching signed, unsigned, and sci.-not. (&quot;1e10&quot;) numbers.&quot;&quot;&quot;</span>

<span class="c1"># Optional range, e.g., --10 (which means &quot;to negative 10&quot;); in my</span>
<span class="c1"># interpretation, the &quot;to&quot; number should be *INCLUDED* in the list</span>
<span class="c1"># If there&#39;s a range, optional stepsize, e.g., --10 (which means</span>
<span class="c1"># &quot;to negative 10&quot;)</span>
<span class="n">HRGROUP_RESTR</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">NUMBER_RESTR</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:-&#39;</span> <span class="o">+</span> <span class="n">NUMBER_RESTR</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:\:&#39;</span> <span class="o">+</span> <span class="n">NUMBER_RESTR</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;){0,1}&#39;</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;){0,1}&#39;</span>
<span class="p">)</span>
<span class="n">HRGROUP_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">HRGROUP_RESTR</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="c1"># Characters to ignore are anything EXCEPT the characters we use</span>
<span class="c1"># (the caret ^ inverts the set in the character class)</span>
<span class="n">IGNORE_CHARS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9e:.,;+-]&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="n">TEX_BACKSLASH_CHARS</span> <span class="o">=</span> <span class="s1">&#39;%$#_</span><span class="si">{}</span><span class="s1">&#39;</span>
<span class="n">TEX_SPECIAL_CHARS_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;~&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\textasciitilde&#39;</span><span class="p">,</span>
    <span class="s1">&#39;^&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\textasciicircum&#39;</span><span class="p">,</span>
    <span class="s1">&#39; &#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sin&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\sin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cos&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\cos&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tan&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\tan&#39;</span><span class="p">,</span>
    <span class="c1">#&#39;sqrt&#39;: r&#39;\sqrt{\,}&#39;</span>
    <span class="c1">#&#39;sqrt&#39;: r&#39;\surd&#39;</span>
<span class="p">}</span>

<span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Î¼&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="p">])</span>
<span class="sd">&quot;&quot;&quot;Mapping of powers-of-10 to SI prefixes (orders-of-magnitude)&quot;&quot;&quot;</span>

<span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Mapping of SI prefixes to powers-of-10&quot;&quot;&quot;</span>
<span class="k">for</span> <span class="n">K</span><span class="p">,</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="p">[</span><span class="n">V</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>
<span class="c1"># Allow &quot;u&quot; to map to -6 (micro) as well</span>
<span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>

<span class="n">POWER_OF_1024_TO_BIN_PREFIX</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Ki&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Mi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Gi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Pi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Ei&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Zi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;Yi&#39;</span><span class="p">)</span>
<span class="p">])</span>
<span class="sd">&quot;&quot;&quot;Mapping from powers-of-1024 to binary prefixes&quot;&quot;&quot;</span>

<span class="n">BIN_PREFIX_TO_POWER_OF_1024</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Mapping from binary prefixes to powerorders-of-1024&quot;&quot;&quot;</span>
<span class="k">for</span> <span class="n">K</span><span class="p">,</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">POWER_OF_1024_TO_BIN_PREFIX</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">BIN_PREFIX_TO_POWER_OF_1024</span><span class="p">[</span><span class="n">V</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>


<div class="viewcode-block" id="split">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.split">[docs]</a>
<span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">force_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a string containing a separated list.</span>

<span class="sd">    * Before splitting the list, the string has extraneous whitespace removed</span>
<span class="sd">      from either end.</span>
<span class="sd">    * The strings that result after the split can have their case forced or be</span>
<span class="sd">      left alone.</span>
<span class="sd">    * Whitespace surrounding (but not falling between non-whitespace) in each</span>
<span class="sd">      resulting string is removed.</span>
<span class="sd">    * After all of the above, the value can be parsed further by a</span>
<span class="sd">      user-supplied `parse_func`.</span>

<span class="sd">    Note that repeating a separator without intervening values yields</span>
<span class="sd">    empty-string values.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string : string</span>
<span class="sd">        The string to be split</span>

<span class="sd">    sep : string</span>
<span class="sd">        Separator to look for</span>

<span class="sd">    force_case : None, &#39;lower&#39;, or &#39;upper&#39;</span>
<span class="sd">        Whether to force the case of the resulting items: None does not change</span>
<span class="sd">        the case, while &#39;lower&#39; or &#39;upper&#39; change the case.</span>

<span class="sd">    parse_func : None or callable</span>
<span class="sd">        If a callable is supplied, each item in the list, after the basic</span>
<span class="sd">        parsing, is processed by `parse_func`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lst : list of objects</span>
<span class="sd">        The types of the items in the list depend upon `parse_func` if it is</span>
<span class="sd">        supplied; otherwise, all items are strings.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; print(split(&#39; One, TWO, three &#39;, sep=&#39;,&#39;, force_case=&#39;lower&#39;))</span>
<span class="sd">    [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;]</span>

<span class="sd">    &gt;&gt;&gt; print(split(&#39;One:TWO:three&#39;, sep=&#39;:&#39;))</span>
<span class="sd">    [&#39;One&#39;, &#39;TWO&#39;, &#39;three&#39;]</span>

<span class="sd">    &gt;&gt;&gt; print(split(&#39;one  two  three&#39;, sep=&#39; &#39;))</span>
<span class="sd">    [&#39;one&#39;, &#39;&#39;, &#39;two&#39;, &#39;&#39; , &#39;three&#39;]</span>

<span class="sd">    &gt;&gt;&gt; print(split(&#39;1 2 3&#39;, sep=&#39; &#39;, parse_func=int))</span>
<span class="sd">    [1, 2, 3]</span>

<span class="sd">    &gt;&gt;&gt; from ast import literal_eval</span>
<span class="sd">    &gt;&gt;&gt; print(split(&#39;True; False; None; (1, 2, 3)&#39;, sep=&#39;,&#39;,</span>
<span class="sd">    &gt;&gt;&gt;             parse_func=literal_eval))</span>
<span class="sd">    [True, False, None, (1, 2, 3)]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">force_case</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">force_case</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parse_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">parse_func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`parse_func` must be callable; got </span><span class="si">%s</span><span class="s1"> instead.&#39;</span>
                            <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">parse_func</span><span class="p">))</span>
        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_func</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">funcs</span><span class="p">:</span>
        <span class="n">aggfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">aggfunc</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">aggfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">aggfunc</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">sep</span><span class="p">)]</span></div>


<div class="viewcode-block" id="arg_str_seq_none">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.arg_str_seq_none">[docs]</a>
<span class="k">def</span> <span class="nf">arg_str_seq_none</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple input handler.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inputs : None, string, or iterable of strings</span>
<span class="sd">        Input value(s) provided by caller</span>
<span class="sd">    name : string</span>
<span class="sd">        Name of input, used for producing a meaningful error message</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inputs : None, or list of strings</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError if unrecognized type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input </span><span class="si">%s</span><span class="s1">: Unhandled type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">inputs</span></div>


<div class="viewcode-block" id="arg_to_tuple">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.arg_to_tuple">[docs]</a>
<span class="k">def</span> <span class="nf">arg_to_tuple</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert `arg` to a tuple: None becomes an empty tuple, an isolated</span>
<span class="sd">    string becomes a tuple containing that string, and any iterable or sequence</span>
<span class="sd">    is simply converted into a tuple.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arg : str, sequence of str, iterable of str, or None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arg_tup : tuple of str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unhandled type </span><span class="si">{}</span><span class="s1">, arg=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">arg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">arg</span></div>


<span class="c1"># TODO: allow for scientific notation input to hr*2list, etc.</span>

<div class="viewcode-block" id="hr_range_formatter">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.hr_range_formatter">[docs]</a>
<span class="k">def</span> <span class="nf">hr_range_formatter</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a range (sequence) in a simple and human-readable format by</span>
<span class="sd">    specifying the range&#39;s starting number, ending number (inclusive), and step</span>
<span class="sd">    size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start, end, step : numeric</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If `start` and `end` are integers and `step` is 1, step size is omitted.</span>

<span class="sd">    The format does NOT follow Python&#39;s slicing syntax, in part because the</span>
<span class="sd">    interpretation is meant to differ; e.g.,</span>
<span class="sd">        &#39;0-10:2&#39; includes both 0 and 10 with step size of 2</span>
<span class="sd">    whereas</span>
<span class="sd">        0:10:2 (slicing syntax) excludes 10</span>

<span class="sd">    Numbers are converted to integers if they are equivalent for more compact</span>
<span class="sd">    display.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; hr_range_formatter(start=0, end=10, step=1)</span>
<span class="sd">    &#39;0-10&#39;</span>
<span class="sd">    &gt;&gt;&gt; hr_range_formatter(start=0, end=10, step=2)</span>
<span class="sd">    &#39;0-10:2&#39;</span>
<span class="sd">    &gt;&gt;&gt; hr_range_formatter(start=0, end=3, step=8)</span>
<span class="sd">    &#39;0-3:8&#39;</span>
<span class="sd">    &gt;&gt;&gt; hr_range_formatter(start=0.1, end=3.1, step=1.0)</span>
<span class="sd">    &#39;0.1-3.1:1&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">==</span> <span class="n">step</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="n">start</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">==</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>



<div class="viewcode-block" id="test_hr_range_formatter">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.test_hr_range_formatter">[docs]</a>
<span class="k">def</span> <span class="nf">test_hr_range_formatter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for hr_range_formatter&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">8</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mf">3.1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_hr_range_formatter &gt;&gt;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="list2hrlist">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.list2hrlist">[docs]</a>
<span class="k">def</span> <span class="nf">list2hrlist</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a list of numbers to a compact and human-readable string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst : sequence</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Adapted to make scientific notation work correctly from [1].</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] http://stackoverflow.com/questions/9847601 user Scott B&#39;s adaptation to</span>
<span class="sd">        Python 2 of Rik Poggi&#39;s answer to his question</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; list2hrlist([0, 1])</span>
<span class="sd">    &#39;0,1&#39;</span>
<span class="sd">    &gt;&gt;&gt; list2hrlist([0, 3])</span>
<span class="sd">    &#39;0,3&#39;</span>
<span class="sd">    &gt;&gt;&gt; list2hrlist([0, 1, 2])</span>
<span class="sd">    &#39;0-2&#39;</span>
<span class="sd">    &gt;&gt;&gt; utils.list2hrlist([0.1, 1.1, 2.1, 3.1])</span>
<span class="sd">    &#39;0.1-3.1:1&#39;</span>
<span class="sd">    &gt;&gt;&gt; list2hrlist([0, 1, 2, 4, 5, 6, 20])</span>
<span class="sd">    &#39;0-2,4-6,20&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">lst</span><span class="p">]</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">FTYPE</span><span class="p">)</span><span class="o">.</span><span class="n">resolution</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scan</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">-</span> <span class="n">scan</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">scan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">scan</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">scan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">]))</span>
            <span class="n">scan</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scan</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">],</span> <span class="n">lst</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">step</span><span class="p">))</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hr_range_formatter</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">],</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">-</span> <span class="n">scan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">-</span> <span class="n">scan</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lst</span><span class="p">[</span><span class="n">scan</span><span class="p">:])))</span>

    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>



<div class="viewcode-block" id="test_list2hrlist">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.test_list2hrlist">[docs]</a>
<span class="k">def</span> <span class="nf">test_list2hrlist</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for list2hrlist&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">list2hrlist</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">list2hrlist</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">list2hrlist</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">]))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_list2hrlist &gt;&gt;&#39;</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_hrgroup2list</span><span class="p">(</span><span class="n">hrgroup</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">isint</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test whether a number is *functionally* an integer&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="n">FTYPE</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">num_to_float_or_int</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return int if number is effectively int, otherwise return float&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isint</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">FTYPE</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

    <span class="c1"># Strip all whitespace, brackets, parens, and other ignored characters from</span>
    <span class="c1"># the group string</span>
    <span class="n">hrgroup</span> <span class="o">=</span> <span class="n">IGNORE_CHARS_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">hrgroup</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hrgroup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">hrgroup</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">num_str</span> <span class="o">=</span> <span class="n">HRGROUP_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hrgroup</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="n">range_start</span> <span class="o">=</span> <span class="n">num_to_float_or_int</span><span class="p">(</span><span class="n">num_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># If no range is specified, just return the number</span>
    <span class="k">if</span> <span class="n">num_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">range_start</span><span class="p">]</span>

    <span class="n">range_stop</span> <span class="o">=</span> <span class="n">num_to_float_or_int</span><span class="p">(</span><span class="n">num_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">num_str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">range_stop</span> <span class="o">&gt;=</span> <span class="n">range_start</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="n">num_to_float_or_int</span><span class="p">(</span><span class="n">num_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">all_ints</span> <span class="o">=</span> <span class="n">isint</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isint</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>

    <span class="c1"># Make an *INCLUSIVE* list (as best we can considering floating point mumbo</span>
    <span class="c1"># jumbo)</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span>
            <span class="p">(</span><span class="n">range_stop</span> <span class="o">-</span> <span class="n">range_start</span><span class="p">)</span><span class="o">/</span><span class="n">step_size</span><span class="p">,</span>
            <span class="n">decimals</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="p">)),</span>
        <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="p">)</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="n">range_start</span> <span class="o">+</span> <span class="n">n_steps</span><span class="o">*</span><span class="n">step_size</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">all_ints</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lst</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<div class="viewcode-block" id="hrlist2list">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.hrlist2list">[docs]</a>
<span class="k">def</span> <span class="nf">hrlist2list</span><span class="p">(</span><span class="n">hrlst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert human-readable string specifying a list of numbers to a Python</span>
<span class="sd">    list of numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hrlist : string</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lst : list of numbers</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[,; _]+&#39;</span><span class="p">,</span> <span class="n">WHITESPACE_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">hrlst</span><span class="p">))</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lst</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_hrgroup2list</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lst</span></div>



<div class="viewcode-block" id="hrlol2lol">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.hrlol2lol">[docs]</a>
<span class="k">def</span> <span class="nf">hrlol2lol</span><span class="p">(</span><span class="n">hrlol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a human-readable string specifying a list-of-lists of numbers to</span>
<span class="sd">    a Python list-of-lists of numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hrlol : string</span>
<span class="sd">        Human-readable list-of-lists-of-numbers string. Each list specification</span>
<span class="sd">        is separated by a semicolon, and whitespace is ignored. Refer to</span>
<span class="sd">        `hrlist2list` for list specification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lol : list-of-lists of numbers</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A single number evaluates to a list with a list with a single number.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;1&quot;)</span>
<span class="sd">    [[1]]</span>

<span class="sd">    A sequence of numbers or ranges can be specified separated by commas.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;1, 3.2, 19.8&quot;)</span>
<span class="sd">    [[1, 3.2, 19.8]]</span>

<span class="sd">    A range can be specified with a dash; default is a step size of 1 (or -1 if</span>
<span class="sd">    the end of the range is less than the start of the range); note that the</span>
<span class="sd">    endpoint is included, unlike slicing in Python.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;1-3&quot;)</span>
<span class="sd">    [[1, 2, 3]]</span>

<span class="sd">    The range can go from or to a negative number, and can go in a negative</span>
<span class="sd">    direction.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;-1 - -5&quot;)</span>
<span class="sd">    [[-1, -3, -5]]</span>

<span class="sd">    Multiple lists are separated by semicolons, and parentheses and brackets</span>
<span class="sd">    can be used to make it easier to understand the string.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;1 ; 8 ; [(-10 - -8:2), 1]&quot;)</span>
<span class="sd">    [[1], [8], [-10, -8, 1]]</span>

<span class="sd">    Finally, all of the above can be combined.</span>

<span class="sd">    &gt;&gt;&gt;  hrlol2lol(&quot;1.-3.; 9.5-10.6:0.5,3--1:-1; 12.5-13:0.8&quot;)</span>
<span class="sd">    [[1, 2, 3], [9.5, 10.0, 10.5, 3, 2, 1, 0, -1], [12.5]]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supergroups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[;]+&#39;</span><span class="p">,</span> <span class="n">hrlol</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">hrlist2list</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">supergroups</span><span class="p">]</span></div>



<div class="viewcode-block" id="hrbool2bool">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.hrbool2bool">[docs]</a>
<span class="k">def</span> <span class="nf">hrbool2bool</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a string that a user might input to indicate a boolean value of</span>
<span class="sd">    either True or False and convert to the appropriate Python bool.</span>

<span class="sd">    * Note first that the case used in the string is ignored</span>
<span class="sd">    * &#39;t&#39;, &#39;true&#39;, &#39;1&#39;, &#39;yes&#39;, and &#39;one&#39; all map to True</span>
<span class="sd">    * &#39;f&#39;, &#39;false&#39;, &#39;0&#39;, &#39;no&#39;, and &#39;zero&#39; all map to False</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : string</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    b : bool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;zero&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not parse input &quot;</span><span class="si">%s</span><span class="s1">&quot; to bool.&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span></div>



<div class="viewcode-block" id="engfmt">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.engfmt">[docs]</a>
<span class="k">def</span> <span class="nf">engfmt</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sign_always</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format number as string in engineering format (10^(multiples-of-three)),</span>
<span class="sd">    including the most common metric prefixes (from atto to Exa).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : scalar</span>
<span class="sd">        Number to be formatted</span>
<span class="sd">    sigfigs : int &gt;= 0</span>
<span class="sd">        Number of significant figures to limit the result to; default=3.</span>
<span class="sd">    decimals : int or None</span>
<span class="sd">        Number of decimals to display (zeros filled out as necessary). If None,</span>
<span class="sd">        `decimals` is automatically determined by the magnitude of the</span>
<span class="sd">        significand and the specified `sigfigs`.</span>
<span class="sd">    sign_always : bool</span>
<span class="sd">        Prefix the number with &quot;+&quot; sign if number is positive; otherwise,</span>
<span class="sd">        only negative numbers are prefixed with a sign (&quot;-&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">units</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">magnitude</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span>

    <span class="c1"># Logs don&#39;t like negative numbers...</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">*=</span> <span class="n">sign</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">pfx_mag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">decimals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">decimals</span> <span class="o">=</span> <span class="n">sigfigs</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">mag</span><span class="o">-</span><span class="n">pfx_mag</span><span class="p">)</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">decimals</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

    <span class="n">round_to</span> <span class="o">=</span> <span class="n">decimals</span>
    <span class="k">if</span> <span class="n">sigfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">round_to</span> <span class="o">=</span> <span class="n">sigfigs</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">mag</span><span class="o">-</span><span class="n">pfx_mag</span><span class="p">)</span>

    <span class="n">scaled_rounded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mf">10.0</span><span class="o">**</span><span class="n">pfx_mag</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">sign_always</span> <span class="ow">and</span> <span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
    <span class="n">num_str</span> <span class="o">=</span> <span class="n">sign_str</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="n">sign</span><span class="o">*</span><span class="n">scaled_rounded</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>

    <span class="c1"># Very large or small quantities have their order of magnitude displayed</span>
    <span class="c1"># by printing the exponent rather than showing a prefix; due to my</span>
    <span class="c1"># inability to strip off prefix in Pint quantities (and attach my own</span>
    <span class="c1"># prefix), just use the &quot;e&quot; notation.</span>
    <span class="k">if</span> <span class="n">pfx_mag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">units</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pfx_mag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1"> {1:~} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_str</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1">e</span><span class="si">{1:d}</span><span class="s1"> {2:~} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_str</span><span class="p">,</span> <span class="n">pfx_mag</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

    <span class="c1"># Dimensionless quantities are treated separately since Pint apparently</span>
    <span class="c1"># can&#39;t handle prefixed-dimensionless (e.g., simply &quot;1 k&quot;, &quot;2.2 M&quot;, etc.,</span>
    <span class="c1"># with no units attached).</span>
    <span class="c1">#if units.dimensionless:</span>
    <span class="k">return</span>  <span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1"> </span><span class="si">{1:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_str</span><span class="p">,</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="p">[</span><span class="n">pfx_mag</span><span class="p">])</span></div>



<span class="k">def</span> <span class="nf">append_results</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">ravel_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;m&#39;</span><span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">m</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span> <span class="o">*</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>

<span class="c1"># TODO: mathrm vs. rm?</span>
<div class="viewcode-block" id="text2tex">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.text2tex">[docs]</a>
<span class="k">def</span> <span class="nf">text2tex</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert common characters so they show up the same as TeX&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">txt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">is_tex</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">strip_outer_dollars</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="n">nfig</span> <span class="o">=</span> <span class="n">NuFlavIntGroup</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nfig</span><span class="o">.</span><span class="n">tex</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">TEX_BACKSLASH_CHARS</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TEX_SPECIAL_CHARS_MAPPING</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span><span class="o">%</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># A single character is taken to be a variable name, and so do not make</span>
    <span class="c1"># roman, just wrap in braces (to avoid interference with other characters)</span>
    <span class="c1"># and return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">txt</span>

    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;{\rm </span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">txt</span></div>



<div class="viewcode-block" id="tex_join">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.tex_join">[docs]</a>
<span class="k">def</span> <span class="nf">tex_join</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join TeX-formatted strings together into one, each separated by `sep`.</span>
<span class="sd">    Also, this strips surrounding &#39;$&#39; from each string before joining.&quot;&quot;&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip_outer_dollars</span><span class="p">(</span><span class="n">text2tex</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">strs</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">strs</span><span class="p">)</span></div>



<div class="viewcode-block" id="tex_dollars">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.tex_dollars">[docs]</a>
<span class="k">def</span> <span class="nf">tex_dollars</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">strip_outer_dollars</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">out_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stripped</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">stripped_line</span> <span class="o">=</span> <span class="n">strip_outer_dollars</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stripped_line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">out_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">stripped_line</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_lines</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_tex">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.is_tex">[docs]</a>
<span class="k">def</span> <span class="nf">is_tex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">TEX_BACKSLASH_CHARS</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">TEX_SPECIAL_CHARS_MAPPING</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\rm&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\mathrm&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\theta&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\phi&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">strip_outer_dollars</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="default_map_tex">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.default_map_tex">[docs]</a>
<span class="k">def</span> <span class="nf">default_map_tex</span><span class="p">(</span><span class="nb">map</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">map</span><span class="o">.</span><span class="n">tex</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">map</span><span class="o">.</span><span class="n">tex</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;{\rm </span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">text2tex</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">strip_outer_dollars</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">tex</span><span class="p">)</span></div>



<div class="viewcode-block" id="int2hex">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.int2hex">[docs]</a>
<span class="k">def</span> <span class="nf">int2hex</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">signed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a signed or unsigned integer `bits` long to hexadecimal</span>
<span class="sd">    representation. As many hex characters are returned to fully specify any</span>
<span class="sd">    number `bits` in length regardless of the value of `i`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        The integer to be converted. Signed integers have a range of</span>
<span class="sd">        -2**(bits-1) to 2**(bits-1)-1), while unsigned integers have a range of</span>
<span class="sd">        0 to 2**(bits-1).</span>

<span class="sd">    bits : int</span>
<span class="sd">        Number of bits long the representation is</span>

<span class="sd">    signed : bool</span>
<span class="sd">        Whether the number is a signed integer; this is dependent upon the</span>
<span class="sd">        representation used for numbers, and _not_ whether the value `i` is</span>
<span class="sd">        positive or negative.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    h : string of length ceil(bits/4.0) since it takes this many hex characters</span>
<span class="sd">    to represent a number `bits` long.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bits</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)),</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="hash2hex">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.hash2hex">[docs]</a>
<span class="k">def</span> <span class="nf">hash2hex</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a hash value to its string hexadecimal representation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hash : integer or string</span>
<span class="sd">    bits : integer &gt; 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hash : string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bits</span><span class="o">/</span><span class="mf">4.0</span><span class="p">))</span>
        <span class="n">hex_hash</span> <span class="o">=</span> <span class="nb">hash</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">hex_hash</span> <span class="o">=</span> <span class="n">int2hex</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unhandled `hash` type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="nb">hash</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hex_hash</span></div>



<div class="viewcode-block" id="strip_outer_dollars">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.strip_outer_dollars">[docs]</a>
<span class="k">def</span> <span class="nf">strip_outer_dollars</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip surrounding dollars signs from TeX string, ignoring leading and</span>
<span class="sd">    trailing whitespace&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\$(.*)\$$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span></div>



<div class="viewcode-block" id="strip_outer_parens">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.strip_outer_parens">[docs]</a>
<span class="k">def</span> <span class="nf">strip_outer_parens</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip parentheses surrounding a string, ignoring leading and trailing</span>
<span class="sd">    whitespace&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\{\((.*)\)\}$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\((.*)\)$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span></div>



<span class="c1"># TODO: this is relatively slow (and is called in constructors that are used</span>
<span class="c1"># frequently, e.g. OneDimBinning, MultiDimBinning); can we speed it up any?</span>
<span class="n">RE_INVALID_CHARS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z_]&#39;</span><span class="p">)</span>
<span class="n">RE_LEADING_INVALID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^[^a-zA-Z_]+&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="make_valid_python_name">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.make_valid_python_name">[docs]</a>
<span class="k">def</span> <span class="nf">make_valid_python_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a name a valid Python identifier.</span>

<span class="sd">    From user Triptych at http://stackoverflow.com/questions/3303312</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove invalid characters</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">RE_INVALID_CHARS</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="c1"># Remove leading characters until we find a letter or underscore</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">RE_LEADING_INVALID</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="sep_three_tens">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.sep_three_tens">[docs]</a>
<span class="k">def</span> <span class="nf">sep_three_tens</span><span class="p">(</span><span class="n">strval</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert `sep` char into sequence of chars `strval`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    strval : sequence of chars or string</span>
<span class="sd">        Sequence of chars into which to insert the separator</span>

<span class="sd">    direction : string, one of {&#39;left&#39;, &#39;right&#39;}</span>
<span class="sd">        Use &#39;left&#39; for left of the decimal, and &#39;right&#39; for right of the</span>
<span class="sd">        decimal</span>

<span class="sd">    sep : None or char</span>
<span class="sd">        Separator to insert</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    formatted : list of chars</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">strval</span>

    <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">),</span> <span class="n">direction</span>

    <span class="n">formatted</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strval</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">edge_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strval</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="p">[</span><span class="n">strval</span><span class="p">[</span><span class="n">c_num</span><span class="p">]]</span> <span class="o">+</span> <span class="n">formatted</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">delta</span><span class="o">-</span><span class="n">c_num</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_indices</span><span class="p">:</span>
                <span class="n">formatted</span> <span class="o">=</span> <span class="p">[</span><span class="n">sep</span><span class="p">]</span> <span class="o">+</span> <span class="n">formatted</span>
        <span class="k">return</span> <span class="n">formatted</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strval</span><span class="p">)))</span>
    <span class="n">edge_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="n">formatted</span> <span class="o">+</span> <span class="p">[</span><span class="n">strval</span><span class="p">[</span><span class="n">c_num</span><span class="p">]]</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">c_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_indices</span><span class="p">):</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="n">formatted</span> <span class="o">+</span> <span class="p">[</span><span class="n">sep</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">formatted</span></div>



<div class="viewcode-block" id="format_num">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.format_num">[docs]</a>
<span class="k">def</span> <span class="nf">format_num</span><span class="p">(</span>
    <span class="n">value</span><span class="p">,</span>
    <span class="n">sigfigs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inf_thresh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span><span class="p">,</span>
    <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">always_show_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decstr</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="n">thousands_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">thousandths_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">left_delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">right_delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">expprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">exppostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nanstr</span><span class="o">=</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span>
    <span class="n">infstr</span><span class="o">=</span><span class="s1">&#39;inf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Fine-grained control over formatting a number as a string.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : numeric</span>
<span class="sd">        The number to be formatted.</span>

<span class="sd">    sigfigs : int &gt; 0, optional</span>
<span class="sd">        Use up to this many significant figures for displaying a number. You</span>
<span class="sd">        can use either `sigfigs` or `precision`, but not both. If neither are</span>
<span class="sd">        specified, default is to set `sigfigs` to 8. See also `trailing_zeros`.</span>

<span class="sd">    precision : float, optional</span>
<span class="sd">        Round `value` to a precision the same as the order of magnitude of</span>
<span class="sd">        `precision`. You can use either `precision` or `sigfigs`, but not both.</span>
<span class="sd">        If neither is specified, default is to set `sigfigs` to 8. See also</span>
<span class="sd">        `trailing_zeros`.</span>

<span class="sd">    fmt : None or one of {&#39;sci&#39;, &#39;eng&#39;, &#39;sipre&#39;, &#39;binpre&#39;, &#39;full&#39;}, optional</span>
<span class="sd">        Force a particular format to be used::</span>
<span class="sd">            * None allows the `value` and what is passed for `sci_thresh` and</span>
<span class="sd">              `exponent` to decide whether or not to use scientific notation</span>
<span class="sd">            * &#39;sci&#39; forces scientific notation</span>
<span class="sd">            * &#39;eng&#39; uses the engineering convention of powers divisible by 3</span>
<span class="sd">              (10e6, 100e-9, etc.)</span>
<span class="sd">            * &#39;sipre&#39; uses powers divisible by 3 but uses SI prefixes (e.g. k,</span>
<span class="sd">              M, G, etc.) instead of displaying the exponent</span>
<span class="sd">            * &#39;binpre&#39; uses powers of 1024 and uses IEC prefixes (e.g. Ki, Mi,</span>
<span class="sd">              Gi, etc.) instead displaying the exponent</span>
<span class="sd">            * &#39;full&#39; forces printing all digits left and/or right of the</span>
<span class="sd">              decimal to display the number (no exponent notation or SI/binary</span>
<span class="sd">              prefix will be used)</span>
<span class="sd">        Note that the display of NaN and +/-inf are unaffected by</span>
<span class="sd">        `fmt`.</span>

<span class="sd">    exponent : None, integer, or string, optional</span>
<span class="sd">        Force the number to be scaled with respect to this exponent. If a</span>
<span class="sd">        string prefix is passed and `fmt` is None, then the SI prefix</span>
<span class="sd">        or binary prefix will be used for the number. E.g., ``exponent=3``</span>
<span class="sd">        would cause the number 1 to be expressed as ``&#39;0.001e3&#39;`, while</span>
<span class="sd">        ``exponent=&#39;k&#39;`` would cause it to be displayed as ``&#39;1 m&#39;``. Both &#39;Î¼&#39;</span>
<span class="sd">        and &#39;u&#39; are accepted to mean &quot;micro&quot;. A non-``None`` value for</span>
<span class="sd">        `exponent` forces some form of scientific/engineering notation, so</span>
<span class="sd">        `fmt` cannot be ``&#39;full&#39;`` in this case. Finally, if</span>
<span class="sd">        `fmt` is ``&#39;binpre&#39;`` then `exponent` is applied to 1024.</span>
<span class="sd">        I.e., 1 maps to kibi (Ki), 2 maps to mebi (Mi), etc.</span>

<span class="sd">    sci_thresh : sequence of 2 integers</span>
<span class="sd">        When to switch to scientific notation. The first integer is the order</span>
<span class="sd">        of magnitude of `value` at or above which scientific notation will be</span>
<span class="sd">        used. The second integer indicates the order of magnitude at or below</span>
<span class="sd">        which the most significant digit falls for scientific notation to be</span>
<span class="sd">        used. E.g., ``sci_thresh=(3, -3)`` means that numbers in the</span>
<span class="sd">        ones-of-thousands or greater OR numbers in the ones-of-thousandths or</span>
<span class="sd">        less will be displayed using scientific notation. Note that</span>
<span class="sd">        `fmt`, if not None, overrides this behavior. Default is</span>
<span class="sd">        (10,-5).</span>

<span class="sd">    inf_thresh : numeric, optional</span>
<span class="sd">        Numbers whose magnitude is equal to or greater than this threhshold are</span>
<span class="sd">        considered infinite and therefore displayed using `infstr` (possibly</span>
<span class="sd">        including a sign, as appropriate). Default is np.inf.</span>

<span class="sd">    trailing_zeros : bool, optional</span>
<span class="sd">        Whether to display all significant figures specified by `sigfigs`, even</span>
<span class="sd">        if this results in trailing zeros. Default is False.</span>

<span class="sd">    always_show_sign : bool, optional</span>
<span class="sd">        Always show a sign, whether number is positive or negative, and whether</span>
<span class="sd">        exponent (if present) is positive or negative. Default is False.</span>

<span class="sd">    decstr : string, optional</span>
<span class="sd">        Separator to use for the decimal point. E.g. ``decstr=&#39;.&#39;`` or</span>
<span class="sd">        ``decstr=&#39;,&#39;`` for mthe most common cases, but this can also be used in</span>
<span class="sd">        TeX tables for alignment on decimal points via ``decstr=&#39;&amp;.&amp;&#39;``.</span>
<span class="sd">        Default is &#39;.&#39;.</span>

<span class="sd">    thousands_sep : None or string, optional</span>
<span class="sd">        Separator to use between thousands, e.g. ``thousands_sep=&#39;,&#39;`` to give</span>
<span class="sd">        results like ``&#39;1,000,000&#39;``, or ```thousands_sep=r&#39;\,&#39;`` for TeX</span>
<span class="sd">        formatting with small spaces between thousands. Default is None.</span>

<span class="sd">    thousandths_sep : None or string, optional</span>
<span class="sd">        Separator to use between thousandthss. Default is None.</span>

<span class="sd">    left_delimiter, right_delimiter : None or string, optional</span>
<span class="sd">        Strings to delimit the left and right sides of the resulting string.</span>
<span class="sd">        E.g. ``left_delimiter=&#39;${&#39;`` and ``right_delimiter=&#39;}$&#39;`` could be used</span>
<span class="sd">        to delimit TeX-formatted strings, such that a number is displayed,</span>
<span class="sd">        e.g., as ``r&#39;${1\times10^3}$&#39;``. Defaults are None for both.</span>

<span class="sd">    expprefix, exppostfix : None or string, optional</span>
<span class="sd">        E.g. use `expprefix=&#39;e&#39;` for simple &quot;e&quot; scientific notation (&quot;1e3&quot;),</span>
<span class="sd">        or use `expprefix=r&#39;\times10^{&#39;` and `exppostfix=r&#39;}&#39; for</span>
<span class="sd">        TeX-formatted scientific notation. Use a space (or tex equivalent) for</span>
<span class="sd">        binary and SI prefixes. If scientific notation is to be used,</span>
<span class="sd">        `expprefix` defaults to &#39;e&#39;. If either SI or binary prefixes are to be</span>
<span class="sd">        used, `expprefix` defaults to &#39; &#39; (space). In any case, `exppostfix`</span>
<span class="sd">        defaults to None.</span>

<span class="sd">    nanstr : string, optional</span>
<span class="sd">        Not-a-number (NaN) values will be displayed using this string. Default</span>
<span class="sd">        is &#39;nan&#39; (following the Numpy convention)</span>

<span class="sd">    infstr : string, optional</span>
<span class="sd">        Infinite values will be displayed using this string (note that the sign</span>
<span class="sd">        is prepended, as appropriate). Default is &#39;inf&#39; (following the Numpy</span>
<span class="sd">        convention).</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    formatted : string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">decimal</span><span class="o">.</span><span class="n">localcontext</span><span class="p">()</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
        <span class="c1"># Ensure rounding behavior is same as that of Numpy</span>
        <span class="n">context</span><span class="o">.</span><span class="n">rounding</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">ROUND_HALF_EVEN</span>
        <span class="c1"># Lots of comp precision to avoid floating point &lt;--&gt; decimal issues</span>
        <span class="n">context</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">72</span>
        <span class="n">d_10</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;10&#39;</span><span class="p">)</span>
        <span class="n">d_1024</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1024&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigfigs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sigfigs</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">order_of_precision</span> <span class="o">=</span> <span class="n">precision</span><span class="o">.</span><span class="n">adjusted</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You cannot specify both `sigfigs` and&#39;</span>
                                 <span class="s1">&#39; `precision`&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigfigs</span><span class="p">,</span> <span class="n">Integral</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">float</span><span class="p">(</span><span class="n">sigfigs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">sigfigs</span><span class="p">),</span> \
                        <span class="s1">&#39;`sigfigs`=</span><span class="si">%s</span><span class="s1"> not an int&#39;</span> <span class="o">%</span> <span class="n">sigfigs</span>
                <span class="n">sigfigs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sigfigs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">sigfigs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;`sigfigs`=</span><span class="si">%s</span><span class="s1"> is not &gt; 0&#39;</span> <span class="o">%</span> <span class="n">sigfigs</span>

        <span class="k">if</span> <span class="n">sci_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sci_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;(`sci_thresh[0]`=</span><span class="si">%s</span><span class="s1">) must be &gt;= (`sci_thresh[1]`=</span><span class="si">%s</span><span class="s1">)&#39;</span>
                <span class="o">%</span> <span class="n">sci_thresh</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sci_thresh</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">sci_thresh</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="s1">&#39;eng&#39;</span><span class="p">,</span> <span class="s1">&#39;sipre&#39;</span><span class="p">,</span> <span class="s1">&#39;binpre&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;eng&#39;</span><span class="p">,</span> <span class="s1">&#39;sipre&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exponent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span>
                        <span class="ow">and</span> <span class="n">exponent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;For `fmt`=&quot;</span><span class="si">{}</span><span class="s1">&quot;, `exponent` is </span><span class="si">{}</span><span class="s1">, but must either be&#39;</span>
                        <span class="s1">&#39; an SI prefix </span><span class="si">{}</span><span class="s1"> or a power of 10 corresponding to&#39;</span>
                        <span class="s1">&#39; these </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span>
                                            <span class="n">exponent</span><span class="p">,</span>
                                            <span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                            <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;binpre&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exponent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BIN_PREFIX_TO_POWER_OF_1024</span>
                        <span class="ow">and</span> <span class="n">exponent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">POWER_OF_1024_TO_BIN_PREFIX</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;For `fmt`=&quot;</span><span class="si">{}</span><span class="s1">&quot;, `exponent` is </span><span class="si">{}</span><span class="s1">, but must either be&#39;</span>
                        <span class="s1">&#39; an IEC binary prefix </span><span class="si">{}</span><span class="s1"> or a power of 1024&#39;</span>
                        <span class="s1">&#39; corresponding to these </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">fmt</span><span class="p">,</span>
                            <span class="n">exponent</span><span class="p">,</span>
                            <span class="n">BIN_PREFIX_TO_POWER_OF_1024</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                            <span class="n">POWER_OF_1024_TO_BIN_PREFIX</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)):</span>
                <span class="k">assert</span> <span class="nb">float</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span>
                <span class="n">exponent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span>

        <span class="c1"># TODO: include uncertainties and/or units in final formatted string</span>
        <span class="c1"># TODO: scale out SI prefix if `value` is a Pint Quantity</span>

        <span class="c1"># Strip off units, if present</span>
        <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">quantity_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">units</span> <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">quantity_info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># Strip off uncertainty, if present</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uncertainties</span><span class="o">.</span><span class="n">UFloat</span><span class="p">):</span>
            <span class="n">stddev</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">std_dev</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">nominal_value</span>

        <span class="c1"># In case `value` is a singleton array</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># Fill in empty strings where None might be passed in to mean the same</span>
        <span class="n">thousands_sep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">thousands_sep</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">thousands_sep</span>
        <span class="n">thousandths_sep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">thousandths_sep</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">thousandths_sep</span>
        <span class="n">left_delimiter</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">left_delimiter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">left_delimiter</span>
        <span class="n">right_delimiter</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">right_delimiter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">right_delimiter</span>
        <span class="n">exppostfix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">exppostfix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">exppostfix</span>
        <span class="c1"># NOTE: expprefix defaults depend on the display mode, so are set later</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">left_delimiter</span> <span class="o">+</span> <span class="n">nanstr</span> <span class="o">+</span> <span class="n">right_delimiter</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">inf_thresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">left_delimiter</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">infstr</span> <span class="o">+</span> <span class="n">right_delimiter</span>

        <span class="c1"># NOTE: ``isinf`` check must come _after_ ``neginf`` check since</span>
        <span class="c1"># ``isinf`` returns ``True`` for both -inf and +inf</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">inf_thresh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">always_show_sign</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">return</span> <span class="n">left_delimiter</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">+</span> <span class="n">infstr</span> <span class="o">+</span> <span class="n">right_delimiter</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Integral</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">order_of_mag</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">adjusted</span><span class="p">()</span>
        <span class="c1"># Get the sign from the full precision `value`, before rounding</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>

        <span class="c1"># If no value passed for `fmt`, infer the format from the</span>
        <span class="c1"># exponent (if it&#39;s a binary or SI prefix) OR the order of magnitude of</span>
        <span class="c1"># the number w.r.t. `sci_thresh`.</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exponent</span> <span class="ow">in</span> <span class="n">BIN_PREFIX_TO_POWER_OF_1024</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;binpre&#39;</span>
                <span class="k">elif</span> <span class="n">exponent</span> <span class="ow">in</span> <span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;sipre&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`exponent`=&quot;</span><span class="si">%s</span><span class="s1">&quot; is not a valid SI or&#39;</span>
                                     <span class="s1">&#39; binary prefix&#39;</span> <span class="o">%</span> <span class="n">exponent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">order_of_mag</span> <span class="o">&gt;=</span> <span class="n">sci_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="ow">or</span> <span class="n">order_of_mag</span> <span class="o">&lt;=</span> <span class="n">sci_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;sci&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;sci&#39;</span>

        <span class="c1"># Define `exponent` where appropriate, and calculate `scaled_value` to</span>
        <span class="c1"># account for the exponent, if there is one.</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;sci&#39;</span><span class="p">:</span>
                <span class="n">exponent</span> <span class="o">=</span> <span class="n">order_of_mag</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_10</span><span class="o">**</span><span class="n">exponent</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;eng&#39;</span><span class="p">,</span> <span class="s1">&#39;sipre&#39;</span><span class="p">):</span>
                <span class="n">exponent</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_of_mag</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_10</span><span class="o">**</span><span class="n">exponent</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;sipre&#39;</span><span class="p">:</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;binpre&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Binary prefix valid only for value &gt;= 0&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">ln</span><span class="p">()</span> <span class="o">//</span> <span class="n">d_1024</span><span class="o">.</span><span class="n">ln</span><span class="p">()</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_1024</span><span class="o">**</span><span class="n">exponent</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">POWER_OF_1024_TO_BIN_PREFIX</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">exponent</span> <span class="ow">in</span> <span class="n">BIN_PREFIX_TO_POWER_OF_1024</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_1024</span><span class="o">**</span><span class="n">BIN_PREFIX_TO_POWER_OF_1024</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">exponent</span> <span class="ow">in</span> <span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_10</span><span class="o">**</span><span class="n">SI_PREFIX_TO_ORDER_OF_MAG</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d_10</span><span class="o">**</span><span class="n">exponent</span>

        <span class="n">scaled_value</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">sigfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">leastsig_dig</span> <span class="o">=</span> <span class="n">scaled_value</span><span class="o">.</span><span class="n">adjusted</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">sigfigs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">quantize_at</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">leastsig_dig</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># only other case is that precision is specified</span>
            <span class="n">quantize_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_10</span><span class="o">**</span><span class="n">order_of_precision</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="n">leastsig_dig</span> <span class="o">=</span> <span class="n">quantize_at</span><span class="o">.</span><span class="n">adjusted</span><span class="p">()</span>

        <span class="n">rounded</span> <span class="o">=</span> <span class="n">scaled_value</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">quantize_at</span><span class="p">)</span>

        <span class="c1"># Eliminate trailing zeros in the Decimal representation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trailing_zeros</span><span class="p">:</span>
            <span class="n">rounded</span> <span class="o">=</span> <span class="n">rounded</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

        <span class="n">dec_tup</span> <span class="o">=</span> <span class="n">rounded</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
        <span class="n">mantissa_digits</span> <span class="o">=</span> <span class="n">dec_tup</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">decimal_position</span> <span class="o">=</span> <span class="n">dec_tup</span><span class="o">.</span><span class="n">exponent</span>

        <span class="c1"># Does the number underflow, making it effectively 0?</span>
        <span class="n">underflow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">sigfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mantissa_digits</span><span class="p">)</span> <span class="o">+</span> <span class="n">decimal_position</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sigfigs</span><span class="p">:</span>
                <span class="n">underflow</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">decimal_position</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">sigfigs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">mantissa_digits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># `precision` is specified</span>
            <span class="k">if</span> <span class="n">order_of_mag</span> <span class="o">&lt;</span> <span class="n">order_of_precision</span><span class="p">:</span>
                <span class="n">underflow</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mantissa_digits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
                <span class="n">decimal_position</span> <span class="o">=</span> <span class="n">leastsig_dig</span>

        <span class="n">n_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mantissa_digits</span><span class="p">)</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mantissa_digits</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">decimal_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">decimal_position</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">sep_three_tens</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">thousands_sep</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">decimal_position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">decimal_position</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_digits</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">decstr</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">sep_three_tens</span><span class="p">(</span>
                        <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">decimal_position</span> <span class="o">-</span> <span class="n">n_digits</span><span class="p">)</span> <span class="o">+</span> <span class="n">chars</span><span class="p">,</span>
                        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">thousandths_sep</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">sep_three_tens</span><span class="p">(</span><span class="n">chars</span><span class="p">[:</span><span class="n">decimal_position</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                   <span class="n">sep</span><span class="o">=</span><span class="n">thousands_sep</span><span class="p">)</span>
                    <span class="o">+</span> <span class="p">[</span><span class="n">decstr</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">sep_three_tens</span><span class="p">(</span><span class="n">chars</span><span class="p">[</span><span class="n">decimal_position</span><span class="p">:],</span>
                                     <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">thousandths_sep</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">num_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">always_show_sign</span> <span class="ow">or</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">underflow</span><span class="p">:</span>
            <span class="n">num_str</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">+</span> <span class="n">num_str</span>

        <span class="k">if</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expprefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="s1">&#39;eng&#39;</span><span class="p">):</span>
                    <span class="n">expprefix</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span> <span class="s1">&#39;binpre&#39;</span><span class="p">):</span>
                    <span class="n">expprefix</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expprefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;sipre&#39;</span><span class="p">:</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">ORDER_OF_MAG_TO_SI_PREFIX</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;binpre&#39;</span><span class="p">:</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">POWER_OF_1024_TO_BIN_PREFIX</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">num_str</span> <span class="o">+=</span> <span class="n">expprefix</span> <span class="o">+</span> <span class="n">exponent</span> <span class="o">+</span> <span class="n">exppostfix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exponent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">exp_sign</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">always_show_sign</span><span class="p">:</span>
                    <span class="n">exp_sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exp_sign</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">num_str</span> <span class="o">+=</span> <span class="n">expprefix</span> <span class="o">+</span> <span class="n">exp_sign</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">exppostfix</span>

    <span class="k">return</span> <span class="n">left_delimiter</span> <span class="o">+</span> <span class="n">num_str</span> <span class="o">+</span> <span class="n">right_delimiter</span></div>



<div class="viewcode-block" id="test_format_num">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.test_format_num">[docs]</a>
<span class="k">def</span> <span class="nf">test_format_num</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for the `format_num` function&quot;&quot;&quot;</span>
    <span class="c1"># sci_thresh</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;100&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1e3&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.01&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1e-3&#39;</span>

    <span class="c1"># trailing_zeros</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.00010e-4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.0001e-4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.00010001&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.000100010&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># sigfigs and trailing_zeros</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.0000&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;16&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">160000</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;160000&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">123456789</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">sci_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;123456789&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">1.6e6</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.6e6&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># precision</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">1.2345</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e0</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">1.2345</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.2&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># exponent</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1000 k&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00134</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1.34 m&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="s1">&#39;Ki&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1 Ki&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="s1">&#39;Ki&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1000 Ki&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="s1">&#39;Mi&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1 Mi&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># displaying zero</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.0000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.0000&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0e0&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;eng&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0e0&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0 &#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;binpre&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0 &#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>

    <span class="c1"># exponent + sigfigs or precision causes underflow</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-0.00000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;+0.00000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-0.0000000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;+0.0000000e4&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># exponent + precision, check sigfigs and trailing zeros...</span>
    <span class="c1"># zeros...</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-0.0000000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00010001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;+0.0000000e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="c1"># rounding at least sig digit</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mf">0.00015001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-0.00000002e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.00015001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.00000002e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="c1"># trailing zeros</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mf">0.015001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-0.00000150e4&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">0.015001</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.00000150e4&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># Test thousands_sep and thousandths_sep</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">1000.0001</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">thousands_sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">thousandths_sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1,000.000 100&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># Test specials: +/-inf, nan</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">thousands_sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">thousandths_sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">infstr</span><span class="o">=</span><span class="s1">&#39;INFINITY&#39;</span><span class="p">,</span> <span class="n">always_show_sign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;+INFINITY&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">infstr</span><span class="o">=</span><span class="s1">&#39;INFINITY&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-INFINITY&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">inf_thresh</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="n">inf_thresh</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;-inf&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># eng and sipre with exponent</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.001e6&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.001 M&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">115e3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.1 M&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">115e3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.12 M&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">115e3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.115 M&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">115e3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.1150 M&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">115e3</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e1</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
                   <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0.11500 M&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># TeX formatting (use exp{pre,post}fix, {left,right}_delimiter;</span>
    <span class="c1"># also fmt=&#39;eng&#39;, &#39;sipre&#39;, and &#39;binpre&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">12.5e3</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;eng&#39;</span><span class="p">,</span>
        <span class="n">expprefix</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39; \, \times 10^{&#39;</span><span class="p">,</span>
        <span class="n">exppostfix</span><span class="o">=</span><span class="s1">&#39;}&#39;</span><span class="p">,</span>
        <span class="n">left_delimiter</span><span class="o">=</span><span class="s1">&#39;${&#39;</span><span class="p">,</span>
        <span class="n">right_delimiter</span><span class="o">=</span><span class="s1">&#39;}$&#39;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="sa">r</span><span class="s1">&#39;${12.50 \, \times 10^</span><span class="si">{3}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">12.5e3</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">,</span>
        <span class="n">expprefix</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39; \, {\rm &#39;</span><span class="p">,</span>
        <span class="n">exppostfix</span><span class="o">=</span><span class="s1">&#39;}&#39;</span><span class="p">,</span>
        <span class="n">left_delimiter</span><span class="o">=</span><span class="s1">&#39;${&#39;</span><span class="p">,</span>
        <span class="n">right_delimiter</span><span class="o">=</span><span class="s1">&#39;}$&#39;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="sa">r</span><span class="s1">&#39;${12.5 \, {\rm k}}$&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">12.5e3</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;binpre&#39;</span><span class="p">,</span>
        <span class="n">expprefix</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39; \, {\rm &#39;</span><span class="p">,</span>
        <span class="n">exppostfix</span><span class="o">=</span><span class="s1">&#39;}&#39;</span><span class="p">,</span>
        <span class="n">left_delimiter</span><span class="o">=</span><span class="s1">&#39;${&#39;</span><span class="p">,</span>
        <span class="n">right_delimiter</span><span class="o">=</span><span class="s1">&#39;}$&#39;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="sa">r</span><span class="s1">&#39;${12.21 \, {\rm Ki}}$&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># fmt=&#39;full&#39;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="mf">12.5e10</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;125000000000&#39;</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># specify both fmt=&#39;full&#39; AND exponent (should raise exception)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span>
            <span class="mf">12.5e3</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trailing_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span>
            <span class="n">exponent</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;`fmt`=&quot;full&quot; and `exponent` is defined&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_format_num &gt;&gt;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="timediff">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.timediff">[docs]</a>
<span class="k">def</span> <span class="nf">timediff</span><span class="p">(</span><span class="n">dt_sec</span><span class="p">,</span> <span class="n">hms_always</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sec_decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Smart string formatting for a time difference (in seconds)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dt_sec : numeric</span>
<span class="sd">        Time difference, in seconds</span>
<span class="sd">    hms_always : bool</span>
<span class="sd">        * True</span>
<span class="sd">            Always display hours, minuts, and seconds regardless of the order-</span>
<span class="sd">            of-magnitude of dt_sec</span>
<span class="sd">        * False</span>
<span class="sd">            Display a minimal-length string that is meaningful, by omitting</span>
<span class="sd">            units that are more significant than those necessary to display</span>
<span class="sd">            dt_sec; if...</span>
<span class="sd">            * dt_sec &lt; 1 s</span>
<span class="sd">                Use engineering formatting for the number.</span>
<span class="sd">            * dt_sec is an integer in the range 0-59 (inclusive)</span>
<span class="sd">                `sec_decimals` is ignored and the number is formatted as an</span>
<span class="sd">                integer</span>
<span class="sd">            See Notes below for handling of units.</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    sec_decimals : int</span>
<span class="sd">        Round seconds to this number of digits</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If colon notation (e.g. HH:MM:SS.xxx, MM:SS.xxx, etc.) is not used, the</span>
<span class="sd">    number is only seconds, and is appended by a space &#39; &#39; followed by units</span>
<span class="sd">    of &#39;s&#39; (possibly with a metric prefix).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">sgn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dt_sec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">dt_sec</span> <span class="o">=</span> <span class="n">sgn</span><span class="o">*</span><span class="n">dt_sec</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">dt_sec</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">strdt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">hms_always</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">strdt</span> <span class="o">+=</span> <span class="nb">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;02d&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
    <span class="k">if</span> <span class="n">hms_always</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">strdt</span> <span class="o">+=</span> <span class="nb">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;02d&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>

    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s_fmt</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strdt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;02d&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If no hours or minutes, use SI-prefixed fmt for seconds with 3</span>
        <span class="c1"># decimal places</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hms_always</span><span class="p">:</span>
            <span class="n">nearest_si_order_of_mag</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="n">dt_sec</span><span class="p">)</span><span class="o">.</span><span class="n">adjusted</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="p">)</span>
            <span class="n">sec_str</span> <span class="o">=</span> <span class="n">format_num</span><span class="p">(</span><span class="n">dt_sec</span><span class="p">,</span>
                                 <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">nearest_si_order_of_mag</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">exponent</span><span class="o">=</span><span class="n">nearest_si_order_of_mag</span><span class="p">,</span>
                                 <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;sipre&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sec_str</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span>
        <span class="c1"># Otherwise, round seconds to sec_decimals decimal digits</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sec_decimals</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strdt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s_fmt</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span><span class="n">sec_decimals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sec_decimals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s_fmt</span> <span class="o">=</span> <span class="s1">&#39;02.0f&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_fmt</span> <span class="o">=</span> <span class="s1">&#39;0</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">sec_decimals</span><span class="p">,</span> <span class="n">sec_decimals</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strdt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">strdt</span> <span class="o">+=</span> <span class="nb">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_fmt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strdt</span> <span class="o">+=</span> <span class="nb">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_fmt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; s&#39;</span>

    <span class="k">return</span> <span class="n">sign_str</span> <span class="o">+</span> <span class="n">strdt</span></div>



<div class="viewcode-block" id="test_timediff">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.test_timediff">[docs]</a>
<span class="k">def</span> <span class="nf">test_timediff</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for timediff function&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;20:34&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mf">1234.5678</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;20:34.568&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hms_always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;00:00:01&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">hms_always</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sec_decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;00:00:01.100&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;277:46:40&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">(</span><span class="mf">1e6</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;277:46:41.500&#39;</span><span class="p">,</span> <span class="n">v</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_timediff &gt;&gt;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="timestamp">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">timestamp</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">winsafe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple utility to print out a time, date, or time+date stamp for the</span>
<span class="sd">    time at which the function is called.</span>

<span class="sd">    Calling via defaults (explcitly provided here for reference) .. ::</span>

<span class="sd">        timestamp(d=True, t=True, tz=True, utc=False, winsafe=False)</span>

<span class="sd">    should be equivalent to the shell command .. ::</span>

<span class="sd">        date +&#39;%Y-%m-%dT%H:%M:%S%z&#39;</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------:</span>
<span class="sd">    d : bool</span>
<span class="sd">        Include date (default: True)</span>
<span class="sd">    t : bool</span>
<span class="sd">        Include time (default: True)</span>
<span class="sd">    tz : bool</span>
<span class="sd">        Include timezone offset from UTC (default: True)</span>
<span class="sd">    utc : bool</span>
<span class="sd">        Include UTC time/date (as opposed to local time/date) (default: False)</span>
<span class="sd">    winsafe : bool</span>
<span class="sd">        Omit colons between hours/minutes (default: False)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utc</span><span class="p">:</span>
        <span class="n">time_tuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_tuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>

    <span class="n">dts</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">dts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">time_tuple</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">+=</span> <span class="s1">&#39;T&#39;</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">winsafe</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M%S&#39;</span><span class="p">,</span> <span class="n">time_tuple</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time_tuple</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tz</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">winsafe</span><span class="p">:</span>
                    <span class="n">dts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;+0000&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;+0000&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%z&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">winsafe</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::]</span>
                <span class="n">dts</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">dts</span></div>



<div class="viewcode-block" id="test_timestamp">
<a class="viewcode-back" href="../../../pisa.utils.html#pisa.utils.format.test_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">test_timestamp</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for timestamp function&quot;&quot;&quot;</span>
    <span class="n">date_cmd</span> <span class="o">=</span> <span class="s2">&quot;date +&#39;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&#39;&quot;</span>

    <span class="c1"># In case we call these on either side of a second, repeat a few times if not equal</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">date_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">(</span><span class="n">winsafe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="n">ref</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">test</span> <span class="o">==</span> <span class="n">ref</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">date_cmd</span><span class="si">}</span><span class="s1"> = &quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1">&quot; but timestamp = &quot;</span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;&lt; PASS : test_timestamp &gt;&gt;&#39;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">set_verbosity</span><span class="p">(</span><span class="n">Levels</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">test_hr_range_formatter</span><span class="p">()</span>
    <span class="n">test_list2hrlist</span><span class="p">()</span>
    <span class="n">test_format_num</span><span class="p">()</span>
    <span class="n">test_timediff</span><span class="p">()</span>
    <span class="n">test_timestamp</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The IceCube/PINGU Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>